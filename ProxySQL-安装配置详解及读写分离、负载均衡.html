<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="jxtt7SNjOgF2n38B50ot4vABL5wrt78c4-egillZLik" />



  <meta name="baidu-site-verification" content="DDOqTIr7dF" />




  <meta name="360-site-verification" content="e18c813ac8c162a670b4ac2832d79cf3" />






  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="proxysql," />





  <link rel="alternate" href="/atom.xml" title="Jiessie's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="前言在MySQL的高可用集群环境中，中间件是不可缺少的一部分，它提供了读写分离、负载均衡等各种功能，满足集群的横向、纵向的可扩展。由于官方并没有在这方面推出好的产品，更多的是第三方的产品。如：  ProxySQL  #Percona MaxScale  #MariaDB Atlas     #360开源 OneProxy  #平民软件楼方鑫 MyCat     #社区推广 KingShard #原">
<meta name="keywords" content="proxysql">
<meta property="og:type" content="article">
<meta property="og:title" content="ProxySQL 安装配置详解及读写分离、负载均衡">
<meta property="og:url" content="http://dwj999.github.io/ProxySQL-安装配置详解及读写分离、负载均衡.html">
<meta property="og:site_name" content="Jiessie&#39;s Blog">
<meta property="og:description" content="前言在MySQL的高可用集群环境中，中间件是不可缺少的一部分，它提供了读写分离、负载均衡等各种功能，满足集群的横向、纵向的可扩展。由于官方并没有在这方面推出好的产品，更多的是第三方的产品。如：  ProxySQL  #Percona MaxScale  #MariaDB Atlas     #360开源 OneProxy  #平民软件楼方鑫 MyCat     #社区推广 KingShard #原">
<meta property="og:image" content="http://note.youdao.com/yws/public/resource/eda87c5cc1090ba9cc4be116906c805b/xmlnote/784F7090F01E4C62AE28CA4BB08A82F8/37001">
<meta property="og:updated_time" content="2017-09-13T01:14:35.793Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ProxySQL 安装配置详解及读写分离、负载均衡">
<meta name="twitter:description" content="前言在MySQL的高可用集群环境中，中间件是不可缺少的一部分，它提供了读写分离、负载均衡等各种功能，满足集群的横向、纵向的可扩展。由于官方并没有在这方面推出好的产品，更多的是第三方的产品。如：  ProxySQL  #Percona MaxScale  #MariaDB Atlas     #360开源 OneProxy  #平民软件楼方鑫 MyCat     #社区推广 KingShard #原">
<meta name="twitter:image" content="http://note.youdao.com/yws/public/resource/eda87c5cc1090ba9cc4be116906c805b/xmlnote/784F7090F01E4C62AE28CA4BB08A82F8/37001">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://dwj999.github.io/ProxySQL-安装配置详解及读写分离、负载均衡.html"/>





  <title>ProxySQL 安装配置详解及读写分离、负载均衡 | Jiessie's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?61e780d405f976f630dfbaf52d2beaa9";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">


<script type="text/javascript"
color="0,0,255" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>
<a href="https://github.com/dwj999"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">没伞的孩子必须努力奔跑</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://dwj999.github.io/ProxySQL-安装配置详解及读写分离、负载均衡.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">ProxySQL 安装配置详解及读写分离、负载均衡</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-29T15:58:45+08:00">
                2017-08-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/中间件/" itemprop="url" rel="index">
                    <span itemprop="name">中间件</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/ProxySQL-安装配置详解及读写分离、负载均衡.html" class="leancloud_visitors" data-flag-title="ProxySQL 安装配置详解及读写分离、负载均衡">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  9,064
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  45
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在MySQL的高可用集群环境中，中间件是不可缺少的一部分，它提供了读写分离、负载均衡等各种功能，满足集群的横向、纵向的可扩展。由于官方并没有在这方面推出好的产品，更多的是第三方的产品。如：</p>
<ul>
<li>ProxySQL  #Percona</li>
<li>MaxScale  #MariaDB</li>
<li>Atlas     #360开源</li>
<li>OneProxy  #平民软件楼方鑫</li>
<li>MyCat     #社区推广</li>
<li>KingShard #原Atlas作者离职后使用go开发</li>
<li>TDDL      #阿里巴巴开源</li>
<li>Cobar     #阿里巴巴开源</li>
<li>DBProxy   #美团在360Atlas上修改后开源</li>
<li>Fabric    #官方产品</li>
<li>DRDS      #阿里云分库分表产品</li>
</ul>
<p>本次以测试ProxySQL为例，逐步了解ProxySQL的使用方式。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>环境：<br>ProxySQL:   1.4.1<br>Master:     118.190.67.67<br>Slave:      139.196.95.103(192.168.7.50)</p>
<h2 id="安装配置详解"><a href="#安装配置详解" class="headerlink" title="安装配置详解"></a>安装配置详解</h2><p>官网：<a href="http://www.proxysql.com/" target="_blank" rel="external">http://www.proxysql.com/</a><br>Percona地址：<a href="https://www.percona.com/downloads/proxysql/" target="_blank" rel="external">https://www.percona.com/downloads/proxysql/</a><br>Github地址：<a href="https://github.com/sysown/proxysql/" target="_blank" rel="external">https://github.com/sysown/proxysql/</a><br>本文通过作者编译好的rpm安装，也可通过编译安装的方式安装，本文省略  </p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>下载proxysql可以有三种途径,分别为官网、Percona网站和Github网站<br>本文从github上下载最新稳定版本，这里选择centos67对应的rpm包<br>下载：wget -c -O proxysql-1.4.1-1-centos67.x86_64.rpm <a href="https://github.com/sysown/proxysql/releases/download/v1.4.1/proxysql-1.4.1-1-centos67.x86_64.rpm" target="_blank" rel="external">https://github.com/sysown/proxysql/releases/download/v1.4.1/proxysql-1.4.1-1-centos67.x86_64.rpm</a><br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@iZuf6c08fdv8duubho2b0rZ test]# yum localinstall -y proxysql-1.4.1-1-centos67.x86<span class="emphasis">_64.rpm</span></div><div class="line">Loaded plugins: security</div><div class="line">docker-main-repo                                                                                                                                 | 2.9 kB     00:00     </div><div class="line">Setting up Install Process</div><div class="line">Resolving Dependencies</div><div class="line">There are unfinished transactions remaining. You might consider running yum-complete-transaction first to finish them.</div><div class="line">--&gt; Running transaction check</div><div class="line">---&gt; Package proxysql.x86_64 0:1.4.1-1 will be installed</div><div class="line">--&gt; Finished Dependency Resolution</div><div class="line"></div><div class="line">Dependencies Resolved</div><div class="line"></div><div class="line">========================================================================================================================================================================</div><div class="line"> Package                           Arch                            Version                             Repository                                                  Size</div><div class="line">========================================================================================================================================================================</div><div class="line">Installing:</div><div class="line"><span class="code"> proxysql                          x86_64                          1.4.1-1                             /proxysql-1.4.1-1-centos67.x86_64                           19 M</span></div><div class="line"></div><div class="line"><span class="section">Transaction Summary</span></div><div class="line">========================================================================================================================================================================</div><div class="line">Install       1 Package(s)</div><div class="line"></div><div class="line">Total size: 19 M</div><div class="line">Installed size: 19 M</div><div class="line">Downloading Packages:</div><div class="line">Running rpm<span class="emphasis">_check_</span>debug</div><div class="line">Running Transaction Test</div><div class="line">Transaction Test Succeeded</div><div class="line">Running Transaction</div><div class="line"><span class="code">  Installing : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></div><div class="line"><span class="code">  Verifying  : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></div><div class="line"></div><div class="line">Installed:</div><div class="line"><span class="code">  proxysql.x86_64 0:1.4.1-1                                                                                                                                             </span></div><div class="line"></div><div class="line">Complete!</div></pre></td></tr></table></figure></p>
<p>ProxySQL默认配置文件为/etc/proxysql.cnf,只在第一次启动的时候有用,后续的所有配置都是通过对SQLite数据库的操作,并且不会更新到proxysql中,而是存储在/var/lib/proxysql/proxysql.db中<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@jiessie test]<span class="meta">#  proxysql --version    #查看版本</span></div><div class="line">ProxySQL version <span class="number">1.4</span><span class="number">.1</span><span class="number">-45</span>-gab4e6ee, codename Truls</div><div class="line">[root@jiessie test]<span class="meta"># rpm -ql proxysql   #查看安装的具体内容</span></div><div class="line"><span class="meta-keyword">/etc/</span>init.d/proxysql                    <span class="meta">#启动脚本</span></div><div class="line"><span class="meta-keyword">/etc/</span>proxysql.cnf                       <span class="meta">#默认配置文件</span></div><div class="line"><span class="meta-keyword">/usr/</span>bin/proxysql                       <span class="meta">#执行文件</span></div><div class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/proxysql/</span>tools/proxysql_galera_checker.sh    <span class="meta">#ProxySQL调度程序检查pxc_maint_mode参数状态,持续检测各个节点的状态</span></div><div class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/proxysql/</span>tools/proxysql_galera_writer.pl <span class="meta">#ProxySQL指定一个节点直接将流量写入galera</span></div><div class="line">[root@jiessie test]<span class="meta">#</span></div></pre></td></tr></table></figure></p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>启动之后才会生成存储目录/var/lib/proxysql<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@jiessie test]<span class="comment"># /etc/init.d/proxysql start</span></div><div class="line">Starting ProxySQL: DONE!</div><div class="line">[root@jiessie test]<span class="comment"># ll /var/lib/proxysql/</span></div><div class="line">总用量 108</div><div class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 98304 </span>8月 <span class="number"> 29 </span>15:37 proxysql.db</div><div class="line">-rw-------<span class="number"> 1 </span>root root <span class="number"> 4306 </span>8月 <span class="number"> 29 </span>16:25 proxysql.log</div><div class="line">-rw-r--r--<span class="number"> 1 </span>root root    <span class="number"> 5 </span>8月 <span class="number"> 29 </span>16:25 proxysql.pid</div><div class="line">[root@jiessie test]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<h2 id="内置对象介绍"><a href="#内置对象介绍" class="headerlink" title="内置对象介绍"></a>内置对象介绍</h2><h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><p>启动了6032和6033两个端口,默认管理端口是6032,客户端服务端口是6033,默认的用户名密码都是 admin,通过mysql的客户端可以登录<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[root@jiessie test]<span class="comment"># netstat -tunlp|grep proxysql</span></div><div class="line">tcp        0      0 0.0.0.0:6032                0.0.0.0:*                   LISTEN      5181/proxysql       </div><div class="line">tcp        0      0 0.0.0.0:6033                0.0.0.0:*                   LISTEN      5181/proxysql       </div><div class="line">[root@jiessie test]<span class="comment"># mysql -uadmin -padmin -h127.0.0.1 -P6032</span></div><div class="line">Warning: Using a password on the command line interface can be insecure.</div><div class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</div><div class="line">Your MySQL connection id is 1</div><div class="line">Server version: 5.5.30 (ProxySQL Admin Module)</div><div class="line"></div><div class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</div><div class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</div><div class="line"></div><div class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</div><div class="line">affiliates. Other names may be trademarks of their respective</div><div class="line">owners.</div><div class="line"></div><div class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</div><div class="line"></div><div class="line">MySQL [(none)] 16:28:32 &gt; show databases;</div><div class="line">+-----+---------+-------------------------------+</div><div class="line">| seq | name    | file                          |</div><div class="line">+-----+---------+-------------------------------+</div><div class="line">| 0   | main    |                               |</div><div class="line">| 2   | disk    | /var/lib/proxysql/proxysql.db |</div><div class="line">| 3   | stats   |                               |</div><div class="line">| 4   |<span class="built_in"> monitor </span>|                               |</div><div class="line">+-----+---------+-------------------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 16:28:41 &gt;</div></pre></td></tr></table></figure></p>
<h3 id="内置库"><a href="#内置库" class="headerlink" title="内置库"></a>内置库</h3><p>main：默认数据库名,用于存放后端db实例、用户认证、路由规则等信息。表名以runtime<em>开头的表示proxysql当前运行的配置内容，不能通过dml语句修改。只能修改对应的不以runtime</em>开头的（在内存）里的表，然后LOAD使其生效，SAVE使其存到硬盘以供下次重启加载。<br>disk：是持久化到硬盘的配置，sqlite数据文件。<br>stats：是proxysql运行抓取的统计信息，包括到后端各命令的执行次数、流量、processlist、查询各类汇总、执行时间等。<br>monitor：库存储monitor模块收集的信息，主要是对后端db的健康、延迟检查。  </p>
<h4 id="main库"><a href="#main库" class="headerlink" title="main库"></a>main库</h4><h5 id="runtime-表"><a href="#runtime-表" class="headerlink" title="runtime_表"></a>runtime_表</h5><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">MySQL [main] 17:19:10 &gt; use main</div><div class="line">Database changed</div><div class="line">MySQL [main] 17:22:15 &gt; show tables;</div><div class="line">+--------------------------------------------+</div><div class="line">|<span class="string"> tables                                     </span>|</div><div class="line">+--------------------------------------------+</div><div class="line">|<span class="string"> global_variables                           </span>|</div><div class="line">|<span class="string"> mysql_collations                           </span>|</div><div class="line">|<span class="string"> mysql_group_replication_hostgroups         </span>|</div><div class="line">|<span class="string"> mysql_query_rules                          </span>|</div><div class="line">|<span class="string"> mysql_replication_hostgroups               </span>|</div><div class="line">|<span class="string"> mysql_servers                              </span>|</div><div class="line">|<span class="string"> mysql_users                                </span>|</div><div class="line">|<span class="string"> proxysql_servers                           </span>|</div><div class="line">|<span class="string"> runtime_global_variables                   </span>|</div><div class="line">|<span class="string"> runtime_mysql_group_replication_hostgroups </span>|</div><div class="line">|<span class="string"> runtime_mysql_query_rules                  </span>|</div><div class="line">|<span class="string"> runtime_mysql_replication_hostgroups       </span>|</div><div class="line">|<span class="string"> runtime_mysql_servers                      </span>|</div><div class="line">|<span class="string"> runtime_mysql_users                        </span>|</div><div class="line">|<span class="string"> runtime_proxysql_servers                   </span>|</div><div class="line">|<span class="string"> runtime_scheduler                          </span>|</div><div class="line">|<span class="string"> scheduler                                  </span>|</div><div class="line">+--------------------------------------------+</div><div class="line">17 rows in set (0.00 sec)</div><div class="line"></div><div class="line">MySQL [main] 17:22:16 &gt;</div></pre></td></tr></table></figure>
<p>其中，runtime_开关的表如下：  </p>
<ul>
<li>runtime_global_variables：global_variables的运行时版本  </li>
<li>runtime_mysql_group_replication_hostgroups：mysql_group_replication_hostgroups的运行时版本  </li>
<li>runtime_mysql_query_rules：mysql_query_rules的运行时版本  </li>
<li>runtime_mysql_replication_hostgroups：mysql_replication_hostsgroups的运行时版本  </li>
<li>runtime_mysql_servers：mysql_servers的运行时版本  </li>
<li>runtime_mysql_users：mysql_users的运行时版本  </li>
<li><p>runtime_scheduler：scheduler调度程序的运行时版本</p>
<h6 id="global-variables表"><a href="#global-variables表" class="headerlink" title="global_variables表"></a>global_variables表</h6><p>内置参数表，参考下文</p>
<h6 id="mysql-servers表"><a href="#mysql-servers表" class="headerlink" title="mysql_servers表"></a>mysql_servers表</h6><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">MySQL [main] <span class="number">17</span>:<span class="number">22</span>:<span class="number">16</span> &gt; show create table mysql_servers\G</div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line">       table: mysql_servers</div><div class="line">Create Table: CREATE TABLE mysql_servers (</div><div class="line">    hostgroup_id <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</div><div class="line">    hostname VARCHAR <span class="literal">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    port <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">3306</span>,</div><div class="line">    status VARCHAR CHECK (UPPER(status) <span class="keyword">IN</span> (<span class="string">'ONLINE'</span>,<span class="string">'SHUNNED'</span>,<span class="string">'OFFLINE_SOFT'</span>, <span class="string">'OFFLINE_HARD'</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'ONLINE'</span>,</div><div class="line">    weight <span class="built_in">INT</span> CHECK (weight &gt;= <span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</div><div class="line">    compression <span class="built_in">INT</span> CHECK (compression &gt;=<span class="number">0</span> <span class="literal">AND</span> compression &lt;= <span class="number">102400</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</div><div class="line">    max_connections <span class="built_in">INT</span> CHECK (max_connections &gt;=<span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1000</span>,</div><div class="line">    max_replication_lag <span class="built_in">INT</span> CHECK (max_replication_lag &gt;= <span class="number">0</span> <span class="literal">AND</span> max_replication_lag &lt;= <span class="number">126144000</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</div><div class="line">    use_ssl <span class="built_in">INT</span> CHECK (use_ssl <span class="keyword">IN</span>(<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</div><div class="line">    max_latency_ms <span class="built_in">INT</span> UNSIGNED CHECK (max_latency_ms&gt;=<span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</div><div class="line">    comment VARCHAR <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</div><div class="line">    PRIMARY KEY (hostgroup_id, hostname, port) )</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">MySQL [main] <span class="number">17</span>:<span class="number">34</span>:<span class="number">05</span> &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>hostgroup_id：ProxySQL通过hostgroup的形式组织后端db实例,一个hostgroup代表同属于一个角色。<br>表的主键是(hostgroup_id, hostname, port),以hostname:port在多个hostgroup中存在。<br>一个hostgroup可以有多个实例，即是多个从库，可能通过weight分配权重。<br>hostgroup_id 0是一个特殊的hostgroup，路由查询的时候，没有匹配到规则则默认选择hostgroup 0。  </p>
</li>
<li>status：<br>ONLINE：当前后端实例状态正常。<br>SHUNNED：临时被剔除，可能因为后端too many connection error，或者超过了max_replication_lag。<br>OFFLINE_SOFT：软离线状态，不再接受新的连接，但已建立的连接会等待活跃事务完成。<br>OFFLINE_HARD：硬离线状态，不再接受新的连接，已建立的连接或被强制中断，当后端实例宕机或网络不可达，会出现。  </li>
<li>max_connections：允许连接到该后端实例的最大连接数，不要大于MySQL的max_connections。<br>如果后端实例hostname:port在多个hostgroup里，以较大者为准，而不是各自独立允许的最大连接数。  </li>
<li>max_replication_lag：允许的最大延迟，主库不受影响，默认为0，如果&gt;0，monitor模块监控主从延迟大于阈值时，会临时把它的状态变更为SHUNNED。  </li>
<li>max_latency_ms：mysql_ping响应时间，大于这个阈值会把它从连接池剔除，即使是ONLINE。  </li>
<li>comment：备注，不建设为空。  </li>
<li><p>其他的字段，可通过字面意思理解。  </p>
<h5 id="mysql-users表"><a href="#mysql-users表" class="headerlink" title="mysql_users表"></a>mysql_users表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">MySQL [main] 09:13:02 &gt; show create table mysql_users\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">       table: mysql_users</div><div class="line">Create Table: CREATE TABLE mysql_users (</div><div class="line">    username VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    password VARCHAR,</div><div class="line">    active INT CHECK (active <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</div><div class="line">    use_ssl INT CHECK (use_ssl <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    default_hostgroup INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    default_schema VARCHAR,</div><div class="line">    schema_locked INT CHECK (schema_locked <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    transaction_persistent INT CHECK (transaction_persistent <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</div><div class="line">    fast_forward INT CHECK (fast_forward <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    backend INT CHECK (backend <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</div><div class="line">    frontend INT CHECK (frontend <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</div><div class="line">    max_connections INT CHECK (max_connections &gt;=0) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>10000,</div><div class="line">    PRIMARY KEY (username, backend),</div><div class="line">    UNIQUE (username, frontend))</div><div class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</div><div class="line"></div><div class="line">MySQL [main] 09:13:08 &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>username,password：连接到后端MySQL或ProxySQL实例的凭证,参考<a href="https://github.com/sysown/proxysql/wiki/Passwords-management" target="_blank" rel="external">密码管理</a>。<br>密码可插入明文，也可通过PASSWORD()插入密文，proxysql以*开头判断插入是否是密文。<br>但是runtime_mysql_users里统一是密文，所以明文插入，再SAVE MYSQL USERS TO MEM，此时看到的也是HASH密文。  </p>
</li>
<li>active：是否生效该用户，active=0的用户将在数据库中被跟踪，但不会加载到内存中的数据结构中。  </li>
<li>default_hostgroup：这个用户的请求没有匹配到规则时，默认发到hostgroup，默认0。  </li>
<li>default_schema：这个用户连接时没有指定schema时，默认使用的schema。<br>默认为NULL，实际上受变量mysql-default_schema的影响，默认为information_schema。  </li>
<li>transaction_persistent： 如果设置为1，连接上ProxySQL的会话后，如果在一个hostgroup上开启了事务，那么后续的sql都继续维持在这个hostgroup上，不论是否会匹配上其它路由规则，直到事务结束。  </li>
<li>frontend：如果设置为1，则用户名、密码对ProxySQL进行身份验证。  </li>
<li><p>backend：如果设置为1，则用户名、密码根据任何主机组向mysqld服务器进行身份验证。<br>注意，目前所有用户都需要将“前端”和“后端“都设置为1，未来版本的ProxySQL将分离前端和后端之间的crendentials。以这种方式，前端将永远不会知道直接连接到后端的凭据，强制所有通过ProxySQL的连接并增加系统的安全性。  </p>
<h5 id="mysql-replication-hostgroups表"><a href="#mysql-replication-hostgroups表" class="headerlink" title="mysql_replication_hostgroups表"></a>mysql_replication_hostgroups表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">MySQL [main] 10:<span class="number">18</span>:<span class="number">15</span> &gt; <span class="keyword">show</span> <span class="keyword">create</span> table mysql_replication_hostgroups\G</div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line">       table: mysql_replication_hostgroups</div><div class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE mysql_replication_hostgroups (</div><div class="line">    writer_hostgroup INT CHECK (writer_hostgroup&gt;=<span class="number">0</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</div><div class="line">    reader_hostgroup INT <span class="keyword">NOT</span> <span class="literal">NULL</span> CHECK (reader_hostgroup&lt;&gt;writer_hostgroup <span class="keyword">AND</span> reader_hostgroup&gt;<span class="number">0</span>),</div><div class="line">    comment VARCHAR,</div><div class="line">    <span class="keyword">UNIQUE</span> (reader_hostgroup))</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">MySQL [main] <span class="number">10</span>:<span class="number">18</span>:<span class="number">22</span> &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>定义hostgroup的主从关系。ProxySQL monitor模块会监控hostgroup后端所有servers的read_only变量，如果发现从库的read_only变为0、主库变为1，则认为角色互换了，自动改写mysql_servers表里面hostgroup关系，达到failover效果。  </p>
<h5 id="mysql-query-rules查询规则表"><a href="#mysql-query-rules查询规则表" class="headerlink" title="mysql_query_rules查询规则表"></a>mysql_query_rules查询规则表</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">MySQL [main] <span class="number">10</span>:<span class="number">25</span>:<span class="number">22</span> &gt; show create table mysql_query_rules\G           </div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line">       table: mysql_query_rules</div><div class="line">Create Table: CREATE TABLE mysql_query_rules (</div><div class="line">    rule_id INTEGER PRIMARY KEY AUTOINCREMENT <span class="literal">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    active <span class="built_in">INT</span> CHECK (active <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</div><div class="line">    username VARCHAR,</div><div class="line">    schemaname VARCHAR,</div><div class="line">    flagIN <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</div><div class="line">    client_addr VARCHAR,</div><div class="line">    proxy_addr VARCHAR,</div><div class="line">    proxy_port <span class="built_in">INT</span>,</div><div class="line">    digest VARCHAR,</div><div class="line">    match_digest VARCHAR,</div><div class="line">    match_pattern VARCHAR,</div><div class="line">    negate_match_pattern <span class="built_in">INT</span> CHECK (negate_match_pattern <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</div><div class="line">    re_modifiers VARCHAR <span class="keyword">DEFAULT</span> <span class="string">'CASELESS'</span>,</div><div class="line">    flagOUT <span class="built_in">INT</span>,</div><div class="line">    replace_pattern VARCHAR,</div><div class="line">    destination_hostgroup <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">    cache_ttl <span class="built_in">INT</span> CHECK(cache_ttl &gt; <span class="number">0</span>),</div><div class="line">    reconnect <span class="built_in">INT</span> CHECK (reconnect <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">    timeout <span class="built_in">INT</span> UNSIGNED,</div><div class="line">    retries <span class="built_in">INT</span> CHECK (retries&gt;=<span class="number">0</span> <span class="literal">AND</span> retries &lt;=<span class="number">1000</span>),</div><div class="line">    delay <span class="built_in">INT</span> UNSIGNED,</div><div class="line">    next_query_flagIN <span class="built_in">INT</span> UNSIGNED,</div><div class="line">    mirror_flagOUT <span class="built_in">INT</span> UNSIGNED,</div><div class="line">    mirror_hostgroup <span class="built_in">INT</span> UNSIGNED,</div><div class="line">    error_msg VARCHAR,</div><div class="line">    OK_msg VARCHAR,</div><div class="line">    sticky_conn <span class="built_in">INT</span> CHECK (sticky_conn <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)),</div><div class="line">    multiplex <span class="built_in">INT</span> CHECK (multiplex <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>)),</div><div class="line">    <span class="built_in">log</span> <span class="built_in">INT</span> CHECK (<span class="built_in">log</span> <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)),</div><div class="line">    apply <span class="built_in">INT</span> CHECK(apply <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</div><div class="line">    comment VARCHAR)</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">MySQL [main] <span class="number">10</span>:<span class="number">25</span>:<span class="number">34</span> &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>rule_id：表主键，自增，规则处理是以rule_id为顺序进行。  </p>
</li>
<li>active：只有active=1时的规则才会参与匹配。  </li>
<li>username：过滤匹配用户名的条件，如果是非空值，则仅当连接使用正确的用户名时，查询才匹配。  </li>
<li>schemaname：匹配schemaname的过滤条件，如果是非空值，则仅当连接schemaname用作默认模式时，查询才匹配。  </li>
<li>flagIN,flagOUT,apply：用来定义路由链chains of rules<br>首先会检查flagIN=0的规则，以rule_id的顺序；如果没有匹配上，则走这个用户的default_hostgroup。<br>当匹配一条规则后，会检查flagOUT。<br>如果不为NULL，并且flagIN!=flagOUT，则进入以flagIN为上一个flagOUT值的新规则链。<br>如果不为NULL，并且flagIN=flagOUT，则应用这条规则。<br>如果为NULL，或者apply=1，则结束，应用这条规则。<br>如果最终没有匹配到，则找到这个用户的default_hostgroup。  </li>
<li>client_addr：匹配客户端来源IP。  </li>
<li>proxy_addr,proxy_port：匹配本地proxysql的ip、端口。  </li>
<li>digest：精确匹配的查询。  </li>
<li>match_digest：正则匹配查询。query,digest是指对查询去掉具体值后进行”模糊化“后的查询，类似pt-query-digest的效果。  </li>
<li>match_pattern：正则匹配查询。<br>以上都是匹配查询的规则，1.4版本可以通过变量mysql-query_processor_regex设置，支持RE2和PCRE，1.4版本开始默认为PCRE。  </li>
<li>negate_match_pattern：反向匹配，相当于对match_digest/match_pattern的匹配取反。  </li>
<li>re_modifiers：修改正则匹配的参数，比如默认的：忽略大小写CASELESS、禁用GLOBAL。  </li>
<li>下面是匹配后的行为：  </li>
<li>replace_pattern：查询重写，默认为空。  </li>
<li>destination_hostgroup：路由查询到这个hostgroup，当然如果用户显式start transaction且transaction_persistent=1,那么即使匹配到了，也依然按照事务里第一条sql的路由规则去走的。  </li>
<li>cache_ttl：查询结果缓存的毫秒数。  </li>
<li>timeout：这一类查询执行的的最大时间(毫秒),超时则自动kill。<br>这是对后端DB的保护机制，相当于阿里云RDS的loose_max_statement_time变量的功能，但不同的是，阿里云这个变量的时间时不包括DML操作出现InnoDB行锁等待的时间，而ProxySQL的这个timeout是计算从发送sql到等待响应的时间。默认mysql-default_query_timeout是10h。  </li>
<li>retries：语句在执行失败时，重试次数。默认由mysql-query_retries_on_failure变量指定，为1。建议不要重试，有风险。  </li>
<li>delay：查询延迟执行，这是ProxySQL提供的限流机制，会让其它的查询优先执行。<br>默认值mysql-default_query_delay为0。  </li>
<li>mirror_flagOUT,mirror_hostgroup：与镜像相关的设置。  </li>
<li>error_msg：默认为NULL，如果指定了则这个查询直接被block掉，将error_msg返回给客户端。  </li>
<li>multiplex：连接是否利用，请参考<a href="http://seanlook.com/2017/04/17/mysql-proxysql-multiplexing/" target="_blank" rel="external">文章</a>。  </li>
<li><p>log：是否记录查询日志，可以看到log是否记录的对象是根据规则。<br>要开启日志记录，需要设置变量mysql-eventslog_filename来指定文件名，然后这个log标记为1。但是目前proxysql记录的日志是二进制格式，需要特定的工具才能读取：eventslog_reader_sample。这个工具在源码目录 tools下面。  </p>
<h5 id="scheduler调度表"><a href="#scheduler调度表" class="headerlink" title="scheduler调度表"></a>scheduler调度表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">MySQL [main] 10:<span class="number">27</span>:<span class="number">52</span> &gt; <span class="keyword">show</span> <span class="keyword">create</span> table scheduler\G</div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line">       table: scheduler</div><div class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE scheduler (</div><div class="line">    id INTEGER <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> AUTOINCREMENT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    active INT CHECK (active <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="number">1</span>,</div><div class="line">    interval_ms INTEGER CHECK (interval_ms&gt;=<span class="number">100</span> <span class="keyword">AND</span> interval_ms&lt;=<span class="number">100000000</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    filename VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    arg1 VARCHAR,</div><div class="line">    arg2 VARCHAR,</div><div class="line">    arg3 VARCHAR,</div><div class="line">    arg4 VARCHAR,</div><div class="line">    arg5 VARCHAR,</div><div class="line">    comment VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>)</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">MySQL [main] <span class="number">11</span>:<span class="number">09</span>:<span class="number">59</span> &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>id：调度程序作业的唯一标识符。  </p>
</li>
<li>active：如果设置为1，则作业处于活动状态。</li>
<li>interval_ms：工作的开始频率(以毫秒为单位)，最小interval_ms为100毫秒。  </li>
<li>filename：可执行文件的完整路径。  </li>
<li>arg1-arg5：传递作业的参数。最多5个。  </li>
<li>comment：注释。  </li>
<li>参考<a href="https://github.com/sysown/proxysql/wiki/Scheduler" target="_blank" rel="external">文档</a><h4 id="disk库"><a href="#disk库" class="headerlink" title="disk库"></a>disk库</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">MySQL [main] 15:12:14 &gt; show tables from disk;</div><div class="line"><span class="code">+------------------------------------+</span></div><div class="line"><span class="section">| tables                             |</span></div><div class="line">+------------------------------------+</div><div class="line">| global<span class="emphasis">_variables                   |</span></div><div class="line">| mysql_collations                   |</div><div class="line">| mysql<span class="emphasis">_group_</span>replication<span class="emphasis">_hostgroups |</span></div><div class="line">| mysql_query<span class="emphasis">_rules                  |</span></div><div class="line">| mysql_replication<span class="emphasis">_hostgroups       |</span></div><div class="line">| mysql_servers                      |</div><div class="line">| mysql<span class="emphasis">_users                        |</span></div><div class="line">| proxysql_servers                   |</div><div class="line"><span class="section">| scheduler                          |</span></div><div class="line">+------------------------------------+</div><div class="line">9 rows in set (0.00 sec)</div><div class="line"></div><div class="line">MySQL [main] 15:12:26 &gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>具体的表介绍和main库一致。  </p>
<h4 id="stats库"><a href="#stats库" class="headerlink" title="stats库"></a>stats库</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">MySQL [main] 15:12:26 &gt; show tables from stats;</div><div class="line">+-----------------------------------+</div><div class="line">|<span class="string"> tables                            </span>|</div><div class="line">+-----------------------------------+</div><div class="line">|<span class="string"> global_variables                  </span>|</div><div class="line">|<span class="string"> stats_memory_metrics              </span>|</div><div class="line">|<span class="string"> stats_mysql_commands_counters     </span>|</div><div class="line">|<span class="string"> stats_mysql_connection_pool       </span>|</div><div class="line">|<span class="string"> stats_mysql_connection_pool_reset </span>|</div><div class="line">|<span class="string"> stats_mysql_global                </span>|</div><div class="line">|<span class="string"> stats_mysql_processlist           </span>|</div><div class="line">|<span class="string"> stats_mysql_query_digest          </span>|</div><div class="line">|<span class="string"> stats_mysql_query_digest_reset    </span>|</div><div class="line">|<span class="string"> stats_mysql_query_rules           </span>|</div><div class="line">|<span class="string"> stats_mysql_users                 </span>|</div><div class="line">|<span class="string"> stats_proxysql_servers_metrics    </span>|</div><div class="line">|<span class="string"> stats_proxysql_servers_status     </span>|</div><div class="line">+-----------------------------------+</div><div class="line">13 rows in set (0.00 sec)</div><div class="line"></div><div class="line">MySQL [main] 15:13:53 &gt;</div></pre></td></tr></table></figure>
<h5 id="stats-mysql-commands-counters表"><a href="#stats-mysql-commands-counters表" class="headerlink" title="stats_mysql_commands_counters表"></a>stats_mysql_commands_counters表</h5><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">MySQL [stats] <span class="number">15</span>:<span class="number">15</span>:<span class="number">36</span> &gt; show create table stats.stats_mysql_commands_counters\G</div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line">       table: stats_mysql_commands_counters</div><div class="line">Create Table: CREATE TABLE stats_mysql_commands_counters (</div><div class="line">    Command VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY KEY,</div><div class="line">    Total_Time_us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    Total_cnt <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_100us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_500us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_1ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_5ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_10ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_50ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_100ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_500ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_1s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_5s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_10s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    cnt_INFs)</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">MySQL [stats] <span class="number">15</span>:<span class="number">15</span>:<span class="number">58</span> &gt;</div></pre></td></tr></table></figure>
<ul>
<li>command：已执行的SQL命令的类型，如FLUSH、INSERT、KILL、SELECT FOR UPDATE等。  </li>
<li>Total_Time_us：执行该类型命令的总时间(以毫秒为单位)。  </li>
<li>Total_cnt：执行该类型的命令的总数。  </li>
<li><p>cnt_100us-cnt_INFs：在指定的时间限制内执行的给定类型的命令总数和前一个命令的总数。<br>#####　stats_mysql_connection_pool表</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">MySQL [stats] <span class="symbol">15:15</span><span class="symbol">:58</span> &gt; show create table stats.stats_mysql_connection_pool \G </div><div class="line">*************************** <span class="number">1</span>. <span class="built_in">row</span> ***************************</div><div class="line">       tab<span class="symbol">le:</span> stats_mysql_connection_pool</div><div class="line">Create Tab<span class="symbol">le:</span> CREATE TABLE stats_mysql_connection_pool (</div><div class="line">    hostgroup <span class="built_in">INT</span>,</div><div class="line">    srv_host VARCHAR,</div><div class="line">    srv_port <span class="built_in">INT</span>,</div><div class="line">    status VARCHAR,</div><div class="line">    ConnUsed <span class="built_in">INT</span>,</div><div class="line">    ConnFree <span class="built_in">INT</span>,</div><div class="line">    ConnOK <span class="built_in">INT</span>,</div><div class="line">    ConnERR <span class="built_in">INT</span>,</div><div class="line">    Queries <span class="built_in">INT</span>,</div><div class="line">    Bytes_data_sent <span class="built_in">INT</span>,</div><div class="line">    Bytes_data_recv <span class="built_in">INT</span>,</div><div class="line">    Latency_us <span class="built_in">INT</span>)</div><div class="line"><span class="number">1</span> <span class="built_in">row</span> in set (<span class="number">0.00</span> <span class="built_in">sec</span>)</div><div class="line"></div><div class="line">MySQL [stats] <span class="symbol">15:20</span><span class="symbol">:08</span> &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>hostgroup：后端服务器所属的主机组，单个后端服务器可以属于多个主机组。  </p>
</li>
<li>srv_host,srv_port：mysqld后端服务器正在侦听连接的TCP端点的IP和Port。  </li>
<li>status：后端服务器的状态。可以有ONLINE，SHUNNED，OFFLINE_SOFT，OFFLINE_HARD。  </li>
<li>ConnUsed：ProxySQL当前使用多少个连接来向后端服务器发送查询。  </li>
<li>ConnFree：目前有多少个连接是空闲。  </li>
<li>ConnOK：成功建立了多少个连接。</li>
<li>ConnERR：没有成功建立多少个连接。</li>
<li>Queries：路由到此特定后端服务器的查询数。</li>
<li>Bytes_data_sent：发送到后端的数据量。</li>
<li>Bytes_data_recv：从后端接收的数据量。</li>
<li><p>Latency_ms：从Monitor报告的当前ping以毫秒为单位的延迟时间。</p>
<h5 id="stats-mysql-global表"><a href="#stats-mysql-global表" class="headerlink" title="stats_mysql_global表"></a>stats_mysql_global表</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MySQL [stats] 15:20:08 &gt; show create table stats.stats<span class="emphasis">_mysql_</span>global\G          </div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line"><span class="code">       table: stats_mysql_global</span></div><div class="line">Create Table: CREATE TABLE stats<span class="emphasis">_mysql_</span>global (</div><div class="line"><span class="code">    Variable_Name VARCHAR NOT NULL PRIMARY KEY,</span></div><div class="line"><span class="code">    Variable_Value VARCHAR NOT NULL)</span></div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">MySQL [stats] 15:22:35 &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>Variable_Name：代表与MySQL相关的代理级别的全局统计<br>如Client_Connections_aborted：由于无效凭据或max_connections而导致的前端连接数已达到；<br>如Client_Connections_connected：当前连接的前端连接数。<br>如Client_Connections_created：到目前为止创建的前端连接数。等等。</p>
</li>
<li><p>Variable_Value：统计所对应的值。  </p>
<h5 id="stats-mysql-processlist表"><a href="#stats-mysql-processlist表" class="headerlink" title="stats_mysql_processlist表"></a>stats_mysql_processlist表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">MySQL [stats] 15:24:11 &gt; show create table stats.stats_mysql_processlist\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">       table: stats_mysql_processlist</div><div class="line">Create Table: CREATE TABLE stats_mysql_processlist (</div><div class="line">    ThreadID INT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    SessionID INTEGER PRIMARY KEY,</div><div class="line">   <span class="built_in"> user </span>VARCHAR,</div><div class="line">    db VARCHAR,</div><div class="line">    cli_host VARCHAR,</div><div class="line">    cli_port INT,</div><div class="line">    hostgroup INT,</div><div class="line">    l_srv_host VARCHAR,</div><div class="line">    l_srv_port INT,</div><div class="line">    srv_host VARCHAR,</div><div class="line">    srv_port INT,</div><div class="line">    command VARCHAR,</div><div class="line">    time_ms INT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    <span class="builtin-name">info</span> VARCHAR)</div><div class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</div><div class="line"></div><div class="line">MySQL [stats] 15:26:43 &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>ThreadID：ProxySQL线程的内部ID。  </p>
</li>
<li>SessionID：ProxySQL会话ID，通过这个ID可以进行kill操作。</li>
<li>user：与MySQL客户端连接到ProxySQL的用户。</li>
<li>db：当前选择的数据库。</li>
<li>cli_host,cli_port：连接ProxySQL的IP和TCP端口。</li>
<li>hostgroup：当前主机组。如果正在处理查询，则是查询已被路由或将要路由的主机组，或默认主机组。可以通过这个查看该SQL到底是到哪个HG里。</li>
<li>l_srv_host,l_srv_port：ProxySQL的IP和TCP端口。</li>
<li>srv_host,srv_port：后端MySQL服务器的IP和端口。</li>
<li>command：正在执行的MySQL查询的类型。</li>
<li>time_ms：命令执行的时间(以毫秒为单位)。</li>
<li><p>info：正在执行的SQL。</p>
<h5 id="stats-mysql-query-digest表"><a href="#stats-mysql-query-digest表" class="headerlink" title="stats_mysql_query_digest表"></a>stats_mysql_query_digest表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">MySQL [stats] 15:26:43 &gt; show <span class="keyword">create</span> table stats.stats_mysql_query_digest\G</div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line">       table: stats_mysql_query_digest</div><div class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE stats_mysql_query_digest (</div><div class="line">    hostgroup INT,</div><div class="line">    schemaname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    username VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    digest VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    digest_text VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    count_star INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    first_seen INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    last_seen INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    sum_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    min_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    max_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>(hostgroup, schemaname, username, digest))</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">MySQL [stats] <span class="number">15</span>:<span class="number">29</span>:<span class="number">27</span> &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>hostgroup：发送查询的主机组。值-1表示查询查询缓存。</p>
</li>
<li>schemaname：查询的数据库。</li>
<li>user：连接ProxySQL的用户名。</li>
<li>digest：一个十六进制散列，表示其参数剥离的SQL。</li>
<li>digest_text：参数剥离的实际SQL文本</li>
<li>count_star：执行查询的总次数（参数的值不同）。</li>
<li>first_seen：unix时间戳，是通过代理路由查询的第一时刻。</li>
<li>last_seen：unix时间戳，当查询通过代理路由时的最后一刻（到目前为止）。</li>
<li>sum_time：执行此类查询的总时间（以微秒为单位）。<br>这对于确定应用程序工作负载中花费的最多时间在哪里是非常有用的，并为改进的地方提供了一个良好的起点。</li>
<li><p>min_time,max_time - 执行此类查询时期望的持续时间范围。<br>min_time是到目前为止所看到的最小执行时间，而max_time表示最大执行时间，以微秒为单位。</p>
<h5 id="stats-mysql-query-rules表"><a href="#stats-mysql-query-rules表" class="headerlink" title="stats_mysql_query_rules表"></a>stats_mysql_query_rules表</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MySQL [stats] 15:29:27 &gt; show create table stats.stats<span class="emphasis">_mysql_</span>query_rules\G </div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line"><span class="code">       table: stats_mysql_query_rules</span></div><div class="line">Create Table: CREATE TABLE stats<span class="emphasis">_mysql_</span>query_rules (</div><div class="line"><span class="code">    rule_id INTEGER PRIMARY KEY,</span></div><div class="line"><span class="code">    hits INT NOT NULL)</span></div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">MySQL [stats] 15:31:57 &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>rule_id：路由规则的ID与main.mysql_query_rules的id对应。</p>
</li>
<li>hits：此路由规则的匹配总数。 如果当前传入的查询符合规则，则会记录一次命中。<h4 id="monitor库"><a href="#monitor库" class="headerlink" title="monitor库"></a>monitor库</h4>对后端MySQL的健康检查，由变量mysql-monitor_enabled来确定是否开启Monitor模块。  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">MySQL [stats] 15:35:32 &gt; show tables from monitor;                               </div><div class="line"><span class="code">+------------------------------------+</span></div><div class="line"><span class="section">| tables                             |</span></div><div class="line">+------------------------------------+</div><div class="line">| mysql<span class="emphasis">_server_</span>connect               |</div><div class="line">| mysql<span class="emphasis">_server_</span>connect<span class="emphasis">_log           |</span></div><div class="line">| mysql_server<span class="emphasis">_group_</span>replication<span class="emphasis">_log |</span></div><div class="line">| mysql_server<span class="emphasis">_ping                  |</span></div><div class="line">| mysql_server<span class="emphasis">_ping_</span>log              |</div><div class="line">| mysql<span class="emphasis">_server_</span>read<span class="emphasis">_only_</span>log         |</div><div class="line"><span class="section">| mysql_server_replication_lag_log   |</span></div><div class="line">+------------------------------------+</div><div class="line">7 rows in set (0.00 sec)</div><div class="line"></div><div class="line">MySQL [stats] 15:35:52 &gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="mysql-server-connect-mysql-server-connect-log表"><a href="#mysql-server-connect-mysql-server-connect-log表" class="headerlink" title="mysql_server_connect/mysql_server_connect_log表"></a>mysql_server_connect/mysql_server_connect_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">MySQL [stats] 15:37:39 &gt; show create table monitor.mysql_server_connect\G  </div><div class="line">*************************** 1. row ***************************</div><div class="line">       table: mysql_server_connect</div><div class="line">Create Table: CREATE TABLE mysql_server_connect (</div><div class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</div><div class="line">    time_since INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    time_until INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    connect_success_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    connect_success_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    connect_success_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    connect_success_time_min INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    connect_success_time_max INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    connect_success_time_total INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    connect_failure_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    connect_failure_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    connect_failure_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    PRIMARY KEY (hostname, port))</div><div class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</div><div class="line"></div><div class="line">MySQL [stats] 15:37:46 &gt; show create table monitor.mysql_server_connect_log\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">       table: mysql_server_connect_log</div><div class="line">Create Table: CREATE TABLE mysql_server_connect_log (</div><div class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</div><div class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    connect_success_time_us INT<span class="built_in"> DEFAULT </span>0,</div><div class="line">    connect_error VARCHAR,</div><div class="line">    PRIMARY KEY (hostname, port, time_start_us))</div><div class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</div><div class="line"></div><div class="line">MySQL [stats] 15:37:51 &gt;</div></pre></td></tr></table></figure>
<ul>
<li><p>连接到所有MySQL服务器以检查它们是否可用，该表用来存放检测连接的日志。由变量mysql-monitor_connect_interval来控制其检测的时间间隔，由参数mysql-monitor_connect_timeout控制连接是否超时（默认200毫秒）。</p>
<h5 id="mysql-server-ping-mysql-server-ping-log表"><a href="#mysql-server-ping-mysql-server-ping-log表" class="headerlink" title="mysql_server_ping/mysql_server_ping_log表"></a>mysql_server_ping/mysql_server_ping_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">MySQL [stats] 15:39:23 &gt; show create table monitor.mysql_server_ping\G       </div><div class="line">*************************** 1. row ***************************</div><div class="line">       table: mysql_server_ping</div><div class="line">Create Table: CREATE TABLE mysql_server_ping (</div><div class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</div><div class="line">    time_since INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    time_until INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    ping_success_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    ping_success_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0, ping_success_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    ping_success_time_min INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    ping_success_time_max INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    ping_success_time_total INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    ping_failure_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    ping_failure_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    ping_failure_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    PRIMARY KEY (hostname, port))</div><div class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</div><div class="line"></div><div class="line">MySQL [stats] 15:40:12 &gt; show create table monitor.mysql_server_ping_log\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">       table: mysql_server_ping_log</div><div class="line">Create Table: CREATE TABLE mysql_server_ping_log (</div><div class="line">     hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</div><div class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    ping_success_time_us INT<span class="built_in"> DEFAULT </span>0,</div><div class="line">    ping_error VARCHAR,</div><div class="line">    PRIMARY KEY (hostname, port, time_start_us))</div><div class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</div><div class="line"></div><div class="line">MySQL [stats] 15:40:15 &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>使用mysql_ping API ping后端MySQL服务器检查它们是否可用，该表用来存放ping的日志。由变量mysql-monitor_ping_interval控制ping的时间间隔，默认值：10000（毫秒，相当于10秒）。</p>
<h5 id="mysql-server-replication-lag-log表"><a href="#mysql-server-replication-lag-log表" class="headerlink" title="mysql_server_replication_lag_log表"></a>mysql_server_replication_lag_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">MySQL [stats] 15:40:53 &gt; show create table monitor.mysql_server_replication_lag_log\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">       table: mysql_server_replication_lag_log</div><div class="line">Create Table: CREATE TABLE mysql_server_replication_lag_log (</div><div class="line">     hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</div><div class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</div><div class="line">    success_time_us INT<span class="built_in"> DEFAULT </span>0,</div><div class="line">    repl_lag INT<span class="built_in"> DEFAULT </span>0,</div><div class="line">    <span class="builtin-name">error</span> VARCHAR,</div><div class="line">    PRIMARY KEY (hostname, port, time_start_us))</div><div class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</div><div class="line"></div><div class="line">MySQL [stats] 15:41:12 &gt;</div></pre></td></tr></table></figure>
</li>
<li><p>后端MySQL服务主从延迟的检测。由参数mysql-monitor_replication_lag_interval控制检测间隔时间， 如果复制滞后太大，可以暂时关闭从。由mysql_servers.max_replication_lag列控制。默认值：10000（毫秒，相当于10秒）。</p>
</li>
</ul>
<h4 id="内置参数"><a href="#内置参数" class="headerlink" title="内置参数"></a>内置参数</h4><p>global_variables 1.4版本中有95个参数，参数较多，解释请参考<a href="https://github.com/sysown/proxysql/wiki/Global-variables" target="_blank" rel="external">文档</a>。<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">MySQL [main] 11:16:22 &gt; show variables;</div><div class="line">+-----------------------------------------------------+--------------------+</div><div class="line">|<span class="string"> Variable_name                                       </span>|<span class="string"> Value              </span>|</div><div class="line">+-----------------------------------------------------+--------------------+</div><div class="line">|<span class="string"> admin-admin_credentials                             </span>|<span class="string"> admin:admin        </span>|</div><div class="line">|<span class="string"> admin-cluster_check_interval_ms                     </span>|<span class="string"> 1000               </span>|</div><div class="line">|<span class="string"> admin-cluster_password                              </span>|<span class="string">                    </span>|</div><div class="line">|<span class="string"> admin-cluster_username                              </span>|<span class="string">                    </span>|</div><div class="line">|<span class="string"> admin-hash_passwords                                </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> admin-mysql_ifaces                                  </span>|<span class="string"> 0.0.0.0:6032       </span>|</div><div class="line">|<span class="string"> admin-read_only                                     </span>|<span class="string"> false              </span>|</div><div class="line">|<span class="string"> admin-refresh_interval                              </span>|<span class="string"> 2000               </span>|</div><div class="line">|<span class="string"> admin-stats_credentials                             </span>|<span class="string"> stats:stats        </span>|</div><div class="line">|<span class="string"> admin-telnet_admin_ifaces                           </span>|<span class="string"> (null)             </span>|</div><div class="line">|<span class="string"> admin-telnet_stats_ifaces                           </span>|<span class="string"> (null)             </span>|</div><div class="line">|<span class="string"> admin-version                                       </span>|<span class="string"> 1.4.1-45-gab4e6ee  </span>|</div><div class="line">|<span class="string"> mysql-client_found_rows                             </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-commands_stats                                </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-connect_retries_delay                         </span>|<span class="string"> 1                  </span>|</div><div class="line">|<span class="string"> mysql-connect_retries_on_failure                    </span>|<span class="string"> 10                 </span>|</div><div class="line">|<span class="string"> mysql-connect_timeout_server                        </span>|<span class="string"> 3000               </span>|</div><div class="line">|<span class="string"> mysql-connect_timeout_server_max                    </span>|<span class="string"> 10000              </span>|</div><div class="line">|<span class="string"> mysql-connection_delay_multiplex_ms                 </span>|<span class="string"> 0                  </span>|</div><div class="line">|<span class="string"> mysql-connection_max_age_ms                         </span>|<span class="string"> 0                  </span>|</div><div class="line">|<span class="string"> mysql-default_charset                               </span>|<span class="string"> utf8               </span>|</div><div class="line">|<span class="string"> mysql-default_max_latency_ms                        </span>|<span class="string"> 1000               </span>|</div><div class="line">|<span class="string"> mysql-default_query_delay                           </span>|<span class="string"> 0                  </span>|</div><div class="line">|<span class="string"> mysql-default_query_timeout                         </span>|<span class="string"> 36000000           </span>|</div><div class="line">|<span class="string"> mysql-default_reconnect                             </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-default_schema                                </span>|<span class="string"> information_schema </span>|</div><div class="line">|<span class="string"> mysql-default_sql_mode                              </span>|<span class="string">                    </span>|</div><div class="line">|<span class="string"> mysql-default_time_zone                             </span>|<span class="string"> SYSTEM             </span>|</div><div class="line">|<span class="string"> mysql-enforce_autocommit_on_reads                   </span>|<span class="string"> false              </span>|</div><div class="line">|<span class="string"> mysql-eventslog_filename                            </span>|<span class="string">                    </span>|</div><div class="line">|<span class="string"> mysql-eventslog_filesize                            </span>|<span class="string"> 104857600          </span>|</div><div class="line">|<span class="string"> mysql-forward_autocommit                            </span>|<span class="string"> false              </span>|</div><div class="line">|<span class="string"> mysql-free_connections_pct                          </span>|<span class="string"> 10                 </span>|</div><div class="line">|<span class="string"> mysql-have_compress                                 </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-hostgroup_manager_verbose                     </span>|<span class="string"> 1                  </span>|</div><div class="line">|<span class="string"> mysql-init_connect                                  </span>|<span class="string"> (null)             </span>|</div><div class="line">|<span class="string"> mysql-interfaces                                    </span>|<span class="string"> 0.0.0.0:6033       </span>|</div><div class="line">|<span class="string"> mysql-long_query_time                               </span>|<span class="string"> 1000               </span>|</div><div class="line">|<span class="string"> mysql-max_allowed_packet                            </span>|<span class="string"> 4194304            </span>|</div><div class="line">|<span class="string"> mysql-max_connections                               </span>|<span class="string"> 2048               </span>|</div><div class="line">|<span class="string"> mysql-max_stmts_cache                               </span>|<span class="string"> 10000              </span>|</div><div class="line">|<span class="string"> mysql-max_stmts_per_connection                      </span>|<span class="string"> 20                 </span>|</div><div class="line">|<span class="string"> mysql-max_transaction_time                          </span>|<span class="string"> 14400000           </span>|</div><div class="line">|<span class="string"> mysql-mirror_max_concurrency                        </span>|<span class="string"> 16                 </span>|</div><div class="line">|<span class="string"> mysql-mirror_max_queue_length                       </span>|<span class="string"> 32000              </span>|</div><div class="line">|<span class="string"> mysql-monitor_connect_interval                      </span>|<span class="string"> 60000              </span>|</div><div class="line">|<span class="string"> mysql-monitor_connect_timeout                       </span>|<span class="string"> 600                </span>|</div><div class="line">|<span class="string"> mysql-monitor_enabled                               </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-monitor_groupreplication_healthcheck_interval </span>|<span class="string"> 5000               </span>|</div><div class="line">|<span class="string"> mysql-monitor_groupreplication_healthcheck_timeout  </span>|<span class="string"> 800                </span>|</div><div class="line">|<span class="string"> mysql-monitor_history                               </span>|<span class="string"> 600000             </span>|</div><div class="line">|<span class="string"> mysql-monitor_password                              </span>|<span class="string"> monitor            </span>|</div><div class="line">|<span class="string"> mysql-monitor_ping_interval                         </span>|<span class="string"> 10000              </span>|</div><div class="line">|<span class="string"> mysql-monitor_ping_max_failures                     </span>|<span class="string"> 3                  </span>|</div><div class="line">|<span class="string"> mysql-monitor_ping_timeout                          </span>|<span class="string"> 1000               </span>|</div><div class="line">|<span class="string"> mysql-monitor_query_interval                        </span>|<span class="string"> 60000              </span>|</div><div class="line">|<span class="string"> mysql-monitor_query_timeout                         </span>|<span class="string"> 100                </span>|</div><div class="line">|<span class="string"> mysql-monitor_read_only_interval                    </span>|<span class="string"> 1500               </span>|</div><div class="line">|<span class="string"> mysql-monitor_read_only_timeout                     </span>|<span class="string"> 500                </span>|</div><div class="line">|<span class="string"> mysql-monitor_replication_lag_interval              </span>|<span class="string"> 10000              </span>|</div><div class="line">|<span class="string"> mysql-monitor_replication_lag_timeout               </span>|<span class="string"> 1000               </span>|</div><div class="line">|<span class="string"> mysql-monitor_slave_lag_when_null                   </span>|<span class="string"> 60                 </span>|</div><div class="line">|<span class="string"> mysql-monitor_username                              </span>|<span class="string"> monitor            </span>|</div><div class="line">|<span class="string"> mysql-monitor_wait_timeout                          </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-monitor_writer_is_also_reader                 </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-multiplexing                                  </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-ping_interval_server_msec                     </span>|<span class="string"> 120000             </span>|</div><div class="line">|<span class="string"> mysql-ping_timeout_server                           </span>|<span class="string"> 500                </span>|</div><div class="line">|<span class="string"> mysql-poll_timeout                                  </span>|<span class="string"> 2000               </span>|</div><div class="line">|<span class="string"> mysql-poll_timeout_on_failure                       </span>|<span class="string"> 100                </span>|</div><div class="line">|<span class="string"> mysql-query_cache_size_MB                           </span>|<span class="string"> 256                </span>|</div><div class="line">|<span class="string"> mysql-query_digests                                 </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-query_digests_lowercase                       </span>|<span class="string"> false              </span>|</div><div class="line">|<span class="string"> mysql-query_digests_max_digest_length               </span>|<span class="string"> 2048               </span>|</div><div class="line">|<span class="string"> mysql-query_digests_max_query_length                </span>|<span class="string"> 65000              </span>|</div><div class="line">|<span class="string"> mysql-query_processor_iterations                    </span>|<span class="string"> 0                  </span>|</div><div class="line">|<span class="string"> mysql-query_processor_regex                         </span>|<span class="string"> 1                  </span>|</div><div class="line">|<span class="string"> mysql-query_retries_on_failure                      </span>|<span class="string"> 1                  </span>|</div><div class="line">|<span class="string"> mysql-server_capabilities                           </span>|<span class="string"> 45578              </span>|</div><div class="line">|<span class="string"> mysql-server_version                                </span>|<span class="string"> 5.5.30             </span>|</div><div class="line">|<span class="string"> mysql-servers_stats                                 </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-session_idle_ms                               </span>|<span class="string"> 1000               </span>|</div><div class="line">|<span class="string"> mysql-session_idle_show_processlist                 </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-sessions_sort                                 </span>|<span class="string"> true               </span>|</div><div class="line">|<span class="string"> mysql-shun_on_failures                              </span>|<span class="string"> 5                  </span>|</div><div class="line">|<span class="string"> mysql-shun_recovery_time_sec                        </span>|<span class="string"> 10                 </span>|</div><div class="line">|<span class="string"> mysql-ssl_p2s_ca                                    </span>|<span class="string"> (null)             </span>|</div><div class="line">|<span class="string"> mysql-ssl_p2s_cert                                  </span>|<span class="string"> (null)             </span>|</div><div class="line">|<span class="string"> mysql-ssl_p2s_cipher                                </span>|<span class="string"> (null)             </span>|</div><div class="line">|<span class="string"> mysql-ssl_p2s_key                                   </span>|<span class="string"> (null)             </span>|</div><div class="line">|<span class="string"> mysql-stacksize                                     </span>|<span class="string"> 1048576            </span>|</div><div class="line">|<span class="string"> mysql-threads                                       </span>|<span class="string"> 4                  </span>|</div><div class="line">|<span class="string"> mysql-threshold_query_length                        </span>|<span class="string"> 524288             </span>|</div><div class="line">|<span class="string"> mysql-threshold_resultset_size                      </span>|<span class="string"> 4194304            </span>|</div><div class="line">|<span class="string"> mysql-wait_timeout                                  </span>|<span class="string"> 28800000           </span>|</div><div class="line">+-----------------------------------------------------+--------------------+</div><div class="line">95 rows in set (0.00 sec)</div><div class="line"></div><div class="line">MySQL [main] 11:16:33 &gt;</div></pre></td></tr></table></figure></p>
<h3 id="ProxySQL多层配置设计"><a href="#ProxySQL多层配置设计" class="headerlink" title="ProxySQL多层配置设计"></a>ProxySQL多层配置设计</h3><h4 id="ProxySQL设计模型介绍"><a href="#ProxySQL设计模型介绍" class="headerlink" title="ProxySQL设计模型介绍"></a>ProxySQL设计模型介绍</h4><p>ProxySQL使用多层配置系统，适合满足以下需求：  </p>
<ul>
<li>允许自动更新配置，与MySQL兼容管理界面；  </li>
<li>允许在线修改配置，不用重启ProxySQL；  </li>
<li><p>允许回滚配置；<br>多层配置系统的实现，如下图：  </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">+-------------------------+</div><div class="line">|<span class="string">         RUNTIME         </span>|</div><div class="line">+-------------------------+</div><div class="line">       /|<span class="string">\          </span>|</div><div class="line">        |<span class="string">           </span>|</div><div class="line">    [1] |<span class="string">       [2] </span>|</div><div class="line">        |<span class="string">          \</span>|<span class="string">/</span></div><div class="line">+-------------------------+</div><div class="line">|<span class="string">         MEMORY          </span>|</div><div class="line">+-------------------------+ _</div><div class="line">       /|<span class="string">\          </span>|<span class="string">      </span>|<span class="string">\</span></div><div class="line">        |<span class="string">           </span>|<span class="string">        \</span></div><div class="line">    [3] |<span class="string">       [4] </span>|<span class="string">         \ [5]</span></div><div class="line">        |<span class="string">          \</span>|<span class="string">/         \</span></div><div class="line">+-------------------------+  +-------------------------+</div><div class="line">|<span class="string">          DISK           </span>|<span class="string">  </span>|<span class="string">       CONFIG FILE       </span>|</div><div class="line">+-------------------------+  +-------------------------+</div></pre></td></tr></table></figure>
</li>
<li><p>RUNTIME代表ProxySQL当前生效的配置，包括global_variables、mysql_servers、mysql_users、mysql_query_rules。无法直接修改这里的配置，必须要从下一层load过来。  </p>
</li>
<li><p>MEMORY(main)代表平时在mysql命令行修改的main里的配置，可以认为是SQLite数据库在内存的镜像。可修改以下：    </p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">mysql_server</span>        后端服务器列表</div><div class="line">mysql_users         连接到ProxySQL的用户列表及其凭据 </div><div class="line">mysql_query_rules   将流量路由到不同的后端服务器的规则列表</div><div class="line">global_variables    全局变量列表</div><div class="line">mysql_collat        MySQL排序规则列表</div></pre></td></tr></table></figure>
</li>
<li><p>DISK和CONFIG FILE表示磁盘上SQLite数据库，默认位置在$datadir/proxysql.db，在重新启动过程中，内存中未被保存的配置将丢失。/etc/proxysql.cnf文件只在第一次初始化的时候用到。如要修改端口，还是需要在管理命令行里修改，再save到磁盘。  </p>
<h5 id="ProxySQL多层配置修改示例"><a href="#ProxySQL多层配置修改示例" class="headerlink" title="ProxySQL多层配置修改示例"></a>ProxySQL多层配置修改示例</h5></li>
<li><p>mysql users</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> RUNTIME / LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> MEMORY</div><div class="line">SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> MEMORY / SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> RUNTIME</div><div class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> MEMORY / LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> DISK</div><div class="line">SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> DISK /  SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> MEMORY</div><div class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> CONFIG</div></pre></td></tr></table></figure>
</li>
<li><p>mysql servers </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">TO</span> RUNTIME   让修改的配置生效</div><div class="line"><span class="keyword">SAVE</span> MYSQL SERVERS <span class="keyword">TO</span> <span class="keyword">MEMORY</span></div><div class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">TO</span> <span class="keyword">MEMORY</span></div><div class="line"><span class="keyword">SAVE</span> MYSQL SERVERS <span class="keyword">TO</span> DISK      将修改的配置持久化</div><div class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">FROM</span> CONFIG</div></pre></td></tr></table></figure>
</li>
<li><p>mysql query rules</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> run</div><div class="line"><span class="keyword">save</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> mem</div><div class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> mem</div><div class="line"><span class="keyword">save</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> disk</div><div class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">from</span> config</div></pre></td></tr></table></figure>
</li>
<li><p>mysql variables</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> runtime</div><div class="line"><span class="keyword">save</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></div><div class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></div><div class="line"><span class="keyword">save</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> disk</div><div class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">from</span> config</div></pre></td></tr></table></figure>
</li>
<li><p>admin variables</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> runtime</div><div class="line"><span class="keyword">save</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></div><div class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></div><div class="line"><span class="keyword">save</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> disk</div><div class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">from</span> config</div></pre></td></tr></table></figure>
</li>
<li><p>参考</p>
</li>
<li><a href="https://github.com/sysown/proxysql/wiki/Multi-layer-configuration-system" target="_blank" rel="external">https://github.com/sysown/proxysql/wiki/Multi-layer-configuration-system</a></li>
<li><a href="https://severalnines.com/blog/mysql-load-balancing-proxysql-overview" target="_blank" rel="external">https://severalnines.com/blog/mysql-load-balancing-proxysql-overview</a></li>
<li><a href="http://seanlook.com/2017/04/10/mysql-proxysql-install-config/" target="_blank" rel="external">http://seanlook.com/2017/04/10/mysql-proxysql-install-config/</a></li>
</ul>
<h2 id="ProxySQL读写分离示例"><a href="#ProxySQL读写分离示例" class="headerlink" title="ProxySQL读写分离示例"></a>ProxySQL读写分离示例</h2><h3 id="准备-1"><a href="#准备-1" class="headerlink" title="准备"></a>准备</h3><p>Master:118.190.67.67:3306<br>Slave :139.196.95.103:3306(192.168.7.50)<br>ProxySQL：139.196.95.103:3306(192.168.7.50)<br>版本：percona-server 5.7.18  </p>
<h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><p>主从安装配置省略。  </p>
<h3 id="示例目标"><a href="#示例目标" class="headerlink" title="示例目标"></a>示例目标</h3><p>客户端通过访问ProxySQL的ip，实际访问Master和Slave的效果。  </p>
<h3 id="添加后端DB服务"><a href="#添加后端DB服务" class="headerlink" title="添加后端DB服务"></a>添加后端DB服务</h3><p>100是主库，101是从库，同时主库也处理1/10的读请求，登录ProxySQL管理端设置：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">14</span><span class="selector-pseudo">:22</span><span class="selector-pseudo">:06</span> &gt; <span class="selector-tag">insert</span> <span class="selector-tag">into</span> <span class="selector-tag">mysql_servers</span>(hostgroup_id,hostname,port,weight,comment) <span class="selector-tag">values</span>(<span class="number">100</span>, <span class="string">'118.190.67.67'</span>, <span class="number">3306</span>, <span class="number">1</span>, <span class="string">'db0,ReadWrite'</span>),(<span class="number">101</span>, <span class="string">'192.168.7.50'</span>, <span class="number">3306</span>, <span class="number">9</span>, <span class="string">'db0,ReadOnly'</span>);</div><div class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">2</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure></p>
<h3 id="添加访问用户"><a href="#添加访问用户" class="headerlink" title="添加访问用户"></a>添加访问用户</h3><p>登录Master主库设置监控用户和程序用户(由于是测试使用，权限较大，主机允许所有)：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">MySQL [(none)] 15:51:32 &gt; <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'monitor'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'monitor'</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 15:51:37 &gt; grant <span class="keyword">select</span>,super,process,<span class="keyword">show</span> databases,replication client,replication slave <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'monitor'</span>@<span class="string">'%'</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 15:45:23 &gt; <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'user0'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'password0'</span>;                   </div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 15:49:42 &gt; GRANT <span class="keyword">SELECT</span>, RELOAD, PROCESS, <span class="keyword">SHOW</span> DATABASES, SUPER, LOCK TABLES, <span class="keyword">EXECUTE</span>, <span class="keyword">SHOW</span> <span class="keyword">VIEW</span>, <span class="keyword">TRIGGER</span>, EVENT <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'read0'</span>@<span class="string">'%'</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure></p>
<p>登录ProxySQL管理端设置：<br>这里default_hostgroup指定了hostgroup为100的主库，下文会设置SELECT …FOR UPDATE规则到100，SELECT到101，其他所有的SQL到default_hostgroup，也就是主库。<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">14</span><span class="selector-pseudo">:22</span><span class="selector-pseudo">:15</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_users</span> (username, password, active, default_hostgroup, max_connections) <span class="selector-tag">VALUES</span> (<span class="string">'user0'</span>, <span class="string">'password0'</span>, <span class="number">1</span>, <span class="number">100</span>, <span class="number">1000</span>); </div><div class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">2</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure></p>
<h3 id="添加复制关系"><a href="#添加复制关系" class="headerlink" title="添加复制关系"></a>添加复制关系</h3><p>登录ProxySQL管理端设置：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">MySQL [main] 17:32:46 &gt; INSERT INTO mysql_replication_hostgroups VALUES(100,101,'db0');</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [main] 17:33:30 &gt; load mysql variables to runtime;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [main] 17:33:54 &gt; save mysql variables to disk;</div><div class="line">Query OK, 83 rows affected (0.01 sec)</div><div class="line"></div><div class="line">MySQL [main] 17:35:53 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_read_only_log ORDER BY time_start_us DESC LIMIT 10;</div><div class="line">+---------------+------+------------------+-----------------+-----------+-------+</div><div class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> success_time_us </span>|<span class="string"> read_only </span>|<span class="string"> error </span>|</div><div class="line">+---------------+------+------------------+-----------------+-----------+-------+</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085770195146 </span>|<span class="string"> 630             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085770194710 </span>|<span class="string"> 23722           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085768695087 </span>|<span class="string"> 650             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085768694620 </span>|<span class="string"> 23706           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085767194957 </span>|<span class="string"> 628             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085767194507 </span>|<span class="string"> 23686           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085765694834 </span>|<span class="string"> 634             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085765694387 </span>|<span class="string"> 23669           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085764194744 </span>|<span class="string"> 641             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085764194301 </span>|<span class="string"> 23729           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</div><div class="line">+---------------+------+------------------+-----------------+-----------+-------+</div><div class="line">10 rows in set (0.00 sec)</div></pre></td></tr></table></figure></p>
<h3 id="修改全局变量"><a href="#修改全局变量" class="headerlink" title="修改全局变量"></a>修改全局变量</h3><p>登录ProxySQL管理端设置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-query_retries_on_failure</span>=0;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-max_stmts_per_connection</span>=1000;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-eventslog_filename</span>=<span class="string">'queries.log'</span>;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_slave_lag_when_null</span>=7200;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-ping_timeout_server</span>=1500;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_connect_timeout</span>=1000;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-default_max_latency_ms</span>=2000;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_username</span>=<span class="string">'monitor'</span>;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_password</span>=<span class="string">'monitor'</span>;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-server_version</span>=<span class="string">'5.7.18'</span>;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div></pre></td></tr></table></figure></p>
<p>全局变量生效并保存到磁盘：<br>登录ProxySQL管理端设置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">MySQL [(none)] 14:25:07 &gt; load mysql<span class="built_in"> users </span><span class="keyword">to</span> runtime;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:27 &gt; load mysql servers <span class="keyword">to</span> runtime;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:27 &gt; load mysql variables <span class="keyword">to</span> runtime;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:28 &gt; save mysql<span class="built_in"> users </span><span class="keyword">to</span> disk;</div><div class="line">Query OK, 0 rows affected (0.02 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:36 &gt; save mysql servers <span class="keyword">to</span> disk;</div><div class="line">save mysql variables <span class="keyword">to</span> disk;Query OK, 0 rows affected (0.03 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:37 &gt; save mysql variables <span class="keyword">to</span> disk;</div><div class="line">Query OK, 83 rows affected (0.01 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 14:25:37 &gt; save mysql<span class="built_in"> users </span><span class="keyword">to</span> mem;  -- 可以屏蔽看到的明文密码</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure></p>
<h3 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h3><ul>
<li>ProxySQL使用查询规则来确定路由，如果没有规则用于查询，默认会访问hostgroup 0主机组，会报以下错误：<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@jiessie ~]# mysql -uuser0 -ppassword0 -h 127.0.0.1 -P6033 -e <span class="string">"SELECT 1"</span></div><div class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</div><div class="line"><span class="builtin-name">ERROR</span> 9001 (HY000) at line 1: Max connect timeout reached <span class="keyword">while</span> reaching hostgroup 1 after 2000ms</div></pre></td></tr></table></figure>
</li>
</ul>
<p>设置路由规则：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:14</span> &gt; <span class="selector-tag">use</span> <span class="selector-tag">main</span>;</div><div class="line"><span class="selector-tag">Database</span> <span class="selector-tag">changed</span></div><div class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:15</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_query_rules</span> (active, match_pattern, destination_hostgroup, cache_ttl) <span class="selector-tag">VALUES</span> (<span class="number">1</span>, <span class="string">'^SELECT .* FOR UPDATE'</span>, <span class="number">100</span>, NULL);</div><div class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">1</span> <span class="selector-tag">row</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:17</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_query_rules</span> (active, match_pattern, destination_hostgroup, cache_ttl) <span class="selector-tag">VALUES</span> (<span class="number">1</span>, <span class="string">'^SELECT .*'</span>, <span class="number">101</span>, NULL);</div><div class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">1</span> <span class="selector-tag">row</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:18</span> &gt; <span class="selector-tag">load</span> <span class="selector-tag">mysql</span> <span class="selector-tag">query</span> <span class="selector-tag">rules</span> <span class="selector-tag">to</span> <span class="selector-tag">run</span>;</div><div class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">0</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:56</span> &gt; <span class="selector-tag">save</span> <span class="selector-tag">mysql</span> <span class="selector-tag">query</span> <span class="selector-tag">rules</span> <span class="selector-tag">to</span> <span class="selector-tag">disk</span>;</div><div class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">0</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.03</span> sec)</div></pre></td></tr></table></figure></p>
<h3 id="常用查询"><a href="#常用查询" class="headerlink" title="常用查询"></a>常用查询</h3><ul>
<li><p>查询连接日志：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">MySQL [(none)] 13:45:08 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_connect_log ORDER BY time_start_us DESC LIMIT 10;</div><div class="line">+---------------+------+------------------+-------------------------+---------------+</div><div class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> connect_success_time_us </span>|<span class="string"> connect_error </span>|</div><div class="line">+---------------+------+------------------+-------------------------+---------------+</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590343795072 </span>|<span class="string"> 410                     </span>|<span class="string"> NULL          </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590343780010 </span>|<span class="string"> 69662                   </span>|<span class="string"> NULL          </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590283795083 </span>|<span class="string"> 521                     </span>|<span class="string"> NULL          </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590283779977 </span>|<span class="string"> 68310                   </span>|<span class="string"> NULL          </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590223794987 </span>|<span class="string"> 533                     </span>|<span class="string"> NULL          </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590223779913 </span>|<span class="string"> 53220                   </span>|<span class="string"> NULL          </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590163794887 </span>|<span class="string"> 497                     </span>|<span class="string"> NULL          </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590163779772 </span>|<span class="string"> 71389                   </span>|<span class="string"> NULL          </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590103794788 </span>|<span class="string"> 487                     </span>|<span class="string"> NULL          </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590103779728 </span>|<span class="string"> 68372                   </span>|<span class="string"> NULL          </span>|</div><div class="line">+---------------+------+------------------+-------------------------+---------------+</div><div class="line">10 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
</li>
<li><p>查询ping日志：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">MySQL [(none)] 13:46:22 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_ping_log ORDER BY time_start_us DESC LIMIT 10;</div><div class="line">+---------------+------+------------------+----------------------+------------+</div><div class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> ping_success_time_us </span>|<span class="string"> ping_error </span>|</div><div class="line">+---------------+------+------------------+----------------------+------------+</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590413773092 </span>|<span class="string"> 100                  </span>|<span class="string"> NULL       </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590413770521 </span>|<span class="string"> 23105                </span>|<span class="string"> NULL       </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590403773088 </span>|<span class="string"> 168                  </span>|<span class="string"> NULL       </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590403770479 </span>|<span class="string"> 23080                </span>|<span class="string"> NULL       </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590393772977 </span>|<span class="string"> 135                  </span>|<span class="string"> NULL       </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590393770364 </span>|<span class="string"> 23078                </span>|<span class="string"> NULL       </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590383772899 </span>|<span class="string"> 138                  </span>|<span class="string"> NULL       </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590383770309 </span>|<span class="string"> 23205                </span>|<span class="string"> NULL       </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590373772885 </span>|<span class="string"> 102                  </span>|<span class="string"> NULL       </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590373770291 </span>|<span class="string"> 23099                </span>|<span class="string"> NULL       </span>|</div><div class="line">+---------------+------+------------------+----------------------+------------+</div><div class="line">10 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
</li>
<li><p>查询后端DB状态</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">46</span>:<span class="number">55</span> &gt; SELECT * FROM mysql_servers;</div><div class="line">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</div><div class="line">| <span class="type">hostgroup_id</span> | <span class="type">hostname</span>      | <span class="type">port</span> | <span class="type">status</span> | <span class="type">weight</span> | <span class="type">compression</span> | <span class="type">max_connections</span> | <span class="type">max_replication_lag</span> | <span class="type">use_ssl</span> | <span class="type">max_latency_ms</span> | <span class="type">comment</span>       |</div><div class="line"><span class="type">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</span></div><div class="line">| 100          | <span class="type">118</span><span class="number">.190</span><span class="number">.67</span><span class="number">.67</span> | <span class="type">3306</span> | <span class="type">ONLINE</span> | <span class="type">1</span>      | <span class="type">0</span>           | <span class="type">1000</span>            | <span class="type">0</span>                   | <span class="type">0</span>       | <span class="type">0</span>              | <span class="type">db0</span>,ReadWrite |</div><div class="line"><span class="type">| 101</span>          | <span class="type">192</span><span class="number">.168</span><span class="number">.7</span><span class="number">.50</span>  | <span class="type">3306</span> | <span class="type">ONLINE</span> | <span class="type">9</span>      | <span class="type">0</span>           | <span class="type">1000</span>            | <span class="type">0</span>                   | <span class="type">0</span>       | <span class="type">0</span>              | <span class="type">db0</span>,ReadOnly  |</div><div class="line"><span class="type">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</span></div><div class="line">2 rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>
</li>
<li><p>查询监控状态：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">MySQL [(none)] 13:47:56 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_read_only_log ORDER BY time_start_us DESC LIMIT 10;   </div><div class="line">+---------------+------+------------------+-----------------+-----------+-------+</div><div class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> success_time_us </span>|<span class="string"> read_only </span>|<span class="string"> error </span>|</div><div class="line">+---------------+------+------------------+-----------------+-----------+-------+</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590524103828 </span>|<span class="string"> 577             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590524103406 </span>|<span class="string"> 23499           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590522603717 </span>|<span class="string"> 646             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590522603268 </span>|<span class="string"> 23487           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590521103641 </span>|<span class="string"> 629             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590521103182 </span>|<span class="string"> 23497           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590519603662 </span>|<span class="string"> 639             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590519603201 </span>|<span class="string"> 23525           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590518103492 </span>|<span class="string"> 618             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</div><div class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590518103062 </span>|<span class="string"> 23508           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</div><div class="line">+---------------+------+------------------+-----------------+-----------+-------+</div><div class="line">10 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
</li>
<li><p>查询用户信息：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">MySQL [<span class="params">(none)</span>] 13<span class="function">:49</span><span class="function">:28</span> &gt;  SELECT * FROM mysql_users;   </div><div class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</div><div class="line">| username | password  | active | use_ssl | default_hostgroup | default_schema | schema_locked | transaction_persistent | fast_forward | backend | frontend | max_connections |</div><div class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</div><div class="line">| user0    | password0 | 1      | 0       | 100               | NULL           | 0             | 1                      | 0            | 1       | 1        | 1000            |</div><div class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</div><div class="line">1 row in <span class="keyword">set</span> <span class="params">(0.00 sec)</span></div></pre></td></tr></table></figure>
</li>
<li><p>查询连接池：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">51</span>:<span class="number">19</span> &gt; SELECT * FROM stats.stats_mysql_connection_pool;</div><div class="line">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</div><div class="line">| <span class="type">hostgroup</span> | <span class="type">srv_host</span>      | <span class="type">srv_port</span> | <span class="type">status</span> | <span class="type">ConnUsed</span> | <span class="type">ConnFree</span> | <span class="type">ConnOK</span> | <span class="type">ConnERR</span> | <span class="type">Queries</span> | <span class="type">Bytes_data_sent</span> | <span class="type">Bytes_data_recv</span> | <span class="type">Latency_us</span> |</div><div class="line"><span class="type">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</span></div><div class="line">| 100       | <span class="type">118</span><span class="number">.190</span><span class="number">.67</span><span class="number">.67</span> | <span class="type">3306</span>     | <span class="type">ONLINE</span> | <span class="type">0</span>        | <span class="type">1</span>        | <span class="type">1</span>      | <span class="type">0</span>       | <span class="type">3</span>       | <span class="type">58</span>              | <span class="type">233</span>             | <span class="type">23059</span>      |</div><div class="line"><span class="type">| 101</span>       | <span class="type">192</span><span class="number">.168</span><span class="number">.7</span><span class="number">.50</span>  | <span class="type">3306</span>     | <span class="type">ONLINE</span> | <span class="type">0</span>        | <span class="type">1</span>        | <span class="type">3</span>      | <span class="type">88</span>      | <span class="type">5</span>       | <span class="type">106</span>             | <span class="type">360</span>             | <span class="type">102</span>        |</div><div class="line"><span class="type">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</span></div><div class="line">2 rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>
</li>
<li><p>查询执行命令统计信息：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MySQL [(none)] 13:51:47 &gt; SELECT <span class="symbol">*</span> FROM stats_mysql_commands_counters WHERE Total_cnt;</div><div class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</div><div class="line">|<span class="string"> Command </span>|<span class="string"> Total_Time_us </span>|<span class="string"> Total_cnt </span>|<span class="string"> cnt_100us </span>|<span class="string"> cnt_500us </span>|<span class="string"> cnt_1ms </span>|<span class="string"> cnt_5ms </span>|<span class="string"> cnt_10ms </span>|<span class="string"> cnt_50ms </span>|<span class="string"> cnt_100ms </span>|<span class="string"> cnt_500ms </span>|<span class="string"> cnt_1s </span>|<span class="string"> cnt_5s </span>|<span class="string"> cnt_10s </span>|<span class="string"> cnt_INFs </span>|</div><div class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</div><div class="line">|<span class="string"> SELECT  </span>|<span class="string"> 167664        </span>|<span class="string"> 27        </span>|<span class="string"> 15        </span>|<span class="string"> 4         </span>|<span class="string"> 0       </span>|<span class="string"> 6       </span>|<span class="string"> 0        </span>|<span class="string"> 1        </span>|<span class="string"> 0         </span>|<span class="string"> 1         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</div><div class="line">|<span class="string"> SET     </span>|<span class="string"> 0             </span>|<span class="string"> 2         </span>|<span class="string"> 2         </span>|<span class="string"> 0         </span>|<span class="string"> 0       </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</div><div class="line">|<span class="string"> SHOW    </span>|<span class="string"> 13818         </span>|<span class="string"> 1         </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0       </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|<span class="string"> 1        </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</div><div class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</div><div class="line">3 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
</li>
<li><p>查询路由规则的详情：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">MySQL [(none)] 13:53:05 &gt; SELECT <span class="symbol">*</span> FROM stats_mysql_query_digest ORDER BY sum_time DESC;</div><div class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</div><div class="line">|<span class="string"> hostgroup </span>|<span class="string"> schemaname         </span>|<span class="string"> username </span>|<span class="string"> digest             </span>|<span class="string"> digest_text                      </span>|<span class="string"> count_star </span>|<span class="string"> first_seen </span>|<span class="string"> last_seen  </span>|<span class="string"> sum_time </span>|<span class="string"> min_time </span>|<span class="string"> max_time </span>|</div><div class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</div><div class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 1          </span>|<span class="string"> 1504589288 </span>|<span class="string"> 1504589288 </span>|<span class="string"> 133826   </span>|<span class="string"> 133826   </span>|<span class="string"> 133826   </span>|</div><div class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x02033E45904D3DF0 </span>|<span class="string"> show databases                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504589886 </span>|<span class="string"> 1504589886 </span>|<span class="string"> 13818    </span>|<span class="string"> 13818    </span>|<span class="string"> 13818    </span>|</div><div class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x3765930C7143F468 </span>|<span class="string"> select * from t1                 </span>|<span class="string"> 1          </span>|<span class="string"> 1504589311 </span>|<span class="string"> 1504589311 </span>|<span class="string"> 13466    </span>|<span class="string"> 13466    </span>|<span class="string"> 13466    </span>|</div><div class="line">|<span class="string"> 101       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 2          </span>|<span class="string"> 1504582304 </span>|<span class="string"> 1504583327 </span>|<span class="string"> 7325     </span>|<span class="string"> 3564     </span>|<span class="string"> 3761     </span>|</div><div class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x814EDBB68FBACD5D </span>|<span class="string"> select * from neworders limit ?  </span>|<span class="string"> 2          </span>|<span class="string"> 1504583184 </span>|<span class="string"> 1504583242 </span>|<span class="string"> 5959     </span>|<span class="string"> 2964     </span>|<span class="string"> 2995     </span>|</div><div class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x3765930C7143F468 </span>|<span class="string"> select * from t1                 </span>|<span class="string"> 3          </span>|<span class="string"> 1504583288 </span>|<span class="string"> 1504589859 </span>|<span class="string"> 3386     </span>|<span class="string"> 64       </span>|<span class="string"> 3056     </span>|</div><div class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 2          </span>|<span class="string"> 1504583168 </span>|<span class="string"> 1504583299 </span>|<span class="string"> 3095     </span>|<span class="string"> 117      </span>|<span class="string"> 2978     </span>|</div><div class="line">|<span class="string"> 101       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x620B328FE9D6D71A </span>|<span class="string"> SELECT DATABASE()                </span>|<span class="string"> 2          </span>|<span class="string"> 1504589729 </span>|<span class="string"> 1504589859 </span>|<span class="string"> 607      </span>|<span class="string"> 193      </span>|<span class="string"> 414      </span>|</div><div class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x226CD90D52A2BA0B </span>|<span class="string"> select @@version_comment limit ? </span>|<span class="string"> 8          </span>|<span class="string"> 1504582304 </span>|<span class="string"> 1504589886 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</div><div class="line">|<span class="string"> 100       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x52B8B04283B3A18D </span>|<span class="string"> set names utf8                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504583162 </span>|<span class="string"> 1504583162 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</div><div class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x52B8B04283B3A18D </span>|<span class="string"> set names utf8                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504582582 </span>|<span class="string"> 1504582582 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</div><div class="line">|<span class="string"> 100       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x226CD90D52A2BA0B </span>|<span class="string"> select @@version_comment limit ? </span>|<span class="string"> 6          </span>|<span class="string"> 1504583162 </span>|<span class="string"> 1504583299 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</div><div class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</div><div class="line">12 rows in set (0.00 sec)</div><div class="line"></div><div class="line">MySQL [(none)] 13:55:46 &gt; SELECT hostgroup hg, sum_time, count_star, digest_text FROM stats_mysql_query_digest ORDER BY sum_time DESC;</div><div class="line">+-----+----------+------------+----------------------------------+</div><div class="line">|<span class="string"> hg  </span>|<span class="string"> sum_time </span>|<span class="string"> count_star </span>|<span class="string"> digest_text                      </span>|</div><div class="line">+-----+----------+------------+----------------------------------+</div><div class="line">|<span class="string"> 100 </span>|<span class="string"> 133826   </span>|<span class="string"> 1          </span>|<span class="string"> select * from tables limit ?     </span>|</div><div class="line">|<span class="string"> 100 </span>|<span class="string"> 13818    </span>|<span class="string"> 1          </span>|<span class="string"> show databases                   </span>|</div><div class="line">|<span class="string"> 100 </span>|<span class="string"> 13466    </span>|<span class="string"> 1          </span>|<span class="string"> select * from t1                 </span>|</div><div class="line">|<span class="string"> 101 </span>|<span class="string"> 7325     </span>|<span class="string"> 2          </span>|<span class="string"> select * from tables limit ?     </span>|</div><div class="line">|<span class="string"> 101 </span>|<span class="string"> 5959     </span>|<span class="string"> 2          </span>|<span class="string"> select * from neworders limit ?  </span>|</div><div class="line">|<span class="string"> 101 </span>|<span class="string"> 3386     </span>|<span class="string"> 3          </span>|<span class="string"> select * from t1                 </span>|</div><div class="line">|<span class="string"> 101 </span>|<span class="string"> 3095     </span>|<span class="string"> 2          </span>|<span class="string"> select * from tables limit ?     </span>|</div><div class="line">|<span class="string"> 101 </span>|<span class="string"> 607      </span>|<span class="string"> 2          </span>|<span class="string"> SELECT DATABASE()                </span>|</div><div class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 8          </span>|<span class="string"> select @@version_comment limit ? </span>|</div><div class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 1          </span>|<span class="string"> set names utf8                   </span>|</div><div class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 1          </span>|<span class="string"> set names utf8                   </span>|</div><div class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 6          </span>|<span class="string"> select @@version_comment limit ? </span>|</div><div class="line">+-----+----------+------------+----------------------------------+</div><div class="line">12 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
</li>
<li><p>查询路由规则：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">57</span>:<span class="number">12</span> &gt; SELECT rule_id, match_digest, match_pattern, replace_pattern, cache_ttl, <span class="built_in">apply</span> FROM mysql_query_rules ORDER BY rule_id;</div><div class="line">+---------+--------------+-----------------------+-----------------+-----------+-------+</div><div class="line">| <span class="type">rule_id</span> | <span class="type">match_digest</span> | <span class="type">match_pattern</span>         | <span class="type">replace_pattern</span> | <span class="type">cache_ttl</span> | <span class="type">apply</span> |</div><div class="line"><span class="type">+---------+--------------+-----------------------+-----------------+-----------+-------+</span></div><div class="line">| 10      | <span class="type">NULL</span>         | <span class="type">^SELECT</span> .* FOR UPDATE | <span class="type">NULL</span>            | <span class="type">NULL</span>      | <span class="type">0</span>     |</div><div class="line"><span class="type">| 11</span>      | <span class="type">NULL</span>         | <span class="type">^SELECT</span> .*            | <span class="type">NULL</span>            | <span class="type">NULL</span>      | <span class="type">0</span>     |</div><div class="line"><span class="type">+---------+--------------+-----------------------+-----------------+-----------+-------+</span></div><div class="line">2 rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>
</li>
<li><p>参考：</p>
</li>
<li><a href="https://github.com/sysown/proxysql/wiki/ProxySQL-Configuration#p6033" target="_blank" rel="external">https://github.com/sysown/proxysql/wiki/ProxySQL-Configuration#p6033</a></li>
<li><a href="http://seanlook.com/2017/04/17/mysql-proxysql-route-rw_split/" target="_blank" rel="external">http://seanlook.com/2017/04/17/mysql-proxysql-route-rw_split/</a></li>
<li><a href="http://severalnines.com/blog/how-proxysql-adds-failover-and-query-control-your-mysql-replication-setup" target="_blank" rel="external">http://severalnines.com/blog/how-proxysql-adds-failover-and-query-control-your-mysql-replication-setup</a></li>
</ul>
<h2 id="ProxySQL监控"><a href="#ProxySQL监控" class="headerlink" title="ProxySQL监控"></a>ProxySQL监控</h2><p>PMM是Percona推出的一款很好的监控MySQL和MongoDB的开源工具，安装方便，功能丰富，图表美观，同时也支持ProxySQL的监控，故选择PMM作为ProxySQL的监控软件。<br>这里以ProxySQL服务端(192.168.7.50)为例，作为PMM的客户端，PMM服务器为139.196.99.230,仅演示ProxySQL安装PMM客户端，服务器安装配置省略。  </p>
<h3 id="PMM-Client安装"><a href="#PMM-Client安装" class="headerlink" title="PMM Client安装"></a>PMM Client安装</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">[root@jiessie ~]# yum localinstall -y /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86<span class="emphasis">_64.rpm </span></div><div class="line">Loaded plugins: security</div><div class="line">Setting up Local Package Process</div><div class="line">Examining /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86_64.rpm: proxysql-1.4.1-1.x86<span class="emphasis">_64</span></div><div class="line">Marking /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86_64.rpm to be installed</div><div class="line">Resolving Dependencies</div><div class="line">There are unfinished transactions remaining. You might consider running yum-complete-transaction first to finish them.</div><div class="line">--&gt; Running transaction check</div><div class="line">---&gt; Package proxysql.x86<span class="emphasis">_64 0:1.4.1-1 will be installed</span></div><div class="line">--&gt; Finished Dependency Resolution</div><div class="line"></div><div class="line">Dependencies Resolved</div><div class="line"></div><div class="line">========================================================================================================================================================================</div><div class="line"> Package                           Arch                            Version                             Repository                                                  Size</div><div class="line">========================================================================================================================================================================</div><div class="line">Installing:</div><div class="line"><span class="code"> proxysql                          x86_64                          1.4.1-1                             /proxysql-1.4.1-1-centos67.x86_64                           19 M</span></div><div class="line"></div><div class="line"><span class="section">Transaction Summary</span></div><div class="line">========================================================================================================================================================================</div><div class="line">Install       1 Package(s)</div><div class="line"></div><div class="line">Total size: 19 M</div><div class="line">Installed size: 19 M</div><div class="line">Downloading Packages:</div><div class="line">Running rpm<span class="emphasis">_check_</span>debug</div><div class="line">Running Transaction Test</div><div class="line">Transaction Test Succeeded</div><div class="line">Running Transaction</div><div class="line">Warning: RPMDB altered outside of yum.</div><div class="line"><span class="bullet">** </span>Found 1 pre-existing rpmdb problem(s), <span class="emphasis">'yum check'</span> output follows:</div><div class="line">mysql-community-libs-5.7.16-1.el6.x86<span class="emphasis">_64 has missing requires of mysql-community-common(x86-64) &gt;= ('0', '5.7.9', None)</span></div><div class="line">  Installing : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </div><div class="line"><span class="code">  Verifying  : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></div><div class="line"></div><div class="line">Installed:</div><div class="line"><span class="code">  proxysql.x86_64 0:1.4.1-1                                                                                                                                             </span></div><div class="line"></div><div class="line">Complete!</div><div class="line">[root@jiessie ~]#</div></pre></td></tr></table></figure>
<h3 id="PMM-Client配置"><a href="#PMM-Client配置" class="headerlink" title="PMM Client配置"></a>PMM Client配置</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">[root@jiessie ~]# ifconfig  #查看IP地址</div><div class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:00:DC:49  </div><div class="line">          inet addr:192.168.7.50  Bcast:192.168.15.255  Mask:255.255.240.0</div><div class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div class="line">          RX packets:1017660 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:1380639 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:1000 </div><div class="line">          RX bytes:273791594 (261.1 MiB)  TX bytes:116287303 (110.9 MiB)</div><div class="line"></div><div class="line">lo        Link encap<span class="keyword">:Local</span> Loopback  </div><div class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</div><div class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</div><div class="line">          RX packets:1297762 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:1297762 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:0 </div><div class="line">          RX bytes:141606631 (135.0 MiB)  TX bytes:141606631 (135.0 MiB)</div><div class="line"></div><div class="line">[root@jiessie ~]# pmm-admin<span class="built_in"> config </span>--bind-address 192.168.7.50 --client-address 139.196.95.103 --server 139.196.99.230:8080 --client-name ProxySQL_Test   #添加config</div><div class="line">OK, PMM<span class="built_in"> server </span>is alive.</div><div class="line"></div><div class="line">PMM<span class="built_in"> Server </span>     | 139.196.99.230:8080 <span class="built_in"></span></div><div class="line">Client Name     | ProxySQL_Test<span class="built_in"></span></div><div class="line">Client Address  | 139.196.95.103 (192.168.7.50)</div><div class="line">[root@jiessie ~]# pmm-admin <span class="builtin-name">add</span> linux:metrics --force ProxySQL_Test     #添加Linux监控</div><div class="line">OK, now monitoring this system.</div><div class="line">[root@jiessie ~]# </div><div class="line">[root@jiessie ~]# pmm-admin <span class="builtin-name">add</span> proxysql:metrics --dsn <span class="string">"admin:admin@tcp(127.0.0.1:6032)/"</span> proxysql6032 #添加ProxySQL监控</div><div class="line">OK, now monitoring ProxySQL metrics using DSN admin:***@tcp(localhost:6032)</div><div class="line">[root@jiessie ~]# </div><div class="line">[root@jiessie ~]# pmm-admin list    #查看状态</div><div class="line">pmm-admin 1.3.0</div><div class="line"></div><div class="line">PMM<span class="built_in"> Server </span>     | 139.196.99.230:8080 <span class="built_in"></span></div><div class="line">Client Name     | ProxySQL_Test<span class="built_in"></span></div><div class="line">Client Address  | 139.196.95.103 (192.168.7.50)<span class="built_in"></span></div><div class="line">Service Manager | unix-systemv</div><div class="line"></div><div class="line">----------------- -------------- ----------- -------- ------------------------------ --------<span class="built_in"></span></div><div class="line">SERVICE TYPE      NAME           LOCAL<span class="built_in"> PORT </span> RUNNING  DATA SOURCE                    OPTIONS </div><div class="line">----------------- -------------- ----------- -------- ------------------------------ --------</div><div class="line">linux:metrics     ProxySQL_Test  42000       <span class="literal">YES</span>      -                                      </div><div class="line">mysql:metrics     ProxySQL_Test  42002       <span class="literal">YES</span>      root:***@tcp(127.0.0.1:3306)           </div><div class="line">proxysql:metrics  proxysql6032   42004       <span class="literal">YES</span>      admin:***@tcp(127.0.0.1:6032)          </div><div class="line"></div><div class="line">[root@jiessie ~]#</div></pre></td></tr></table></figure>
<h3 id="PMM-Server监控展示"><a href="#PMM-Server监控展示" class="headerlink" title="PMM Server监控展示"></a>PMM Server监控展示</h3><p>PMM Server监控项包括：</p>
<ul>
<li>客户端连接数</li>
<li>客户端总查询</li>
<li>ProxySQL连接池状态</li>
<li>活动连接</li>
<li>失败连接</li>
<li>客户端查询路由详情</li>
<li>客户端延迟状态</li>
<li>网络接口<br><img src="http://note.youdao.com/yws/public/resource/eda87c5cc1090ba9cc4be116906c805b/xmlnote/784F7090F01E4C62AE28CA4BB08A82F8/37001" alt="image"></li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ProxySQL是一款很出色的MySQL中间件，在稳定性上、易用性、高性能等方面表现很不错。由于发布的时间较短，功能可能还不太完善，需要多做测试，特别是查询路由和规则方面需要详情的了解，测试。可重点关注。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        <div>
	
		<div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
	
</div>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/proxysql/" rel="tag"><i class="fa fa-tag"></i> proxysql</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/删除ibdata1-Table-doesn-t-exist-恢复案例.html" rel="next" title="误删除ibdata1(Table doesn't exist)恢复案例">
                <i class="fa fa-chevron-left"></i> 误删除ibdata1(Table doesn't exist)恢复案例
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html" rel="prev" title="Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7">
                Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div id="sidebar-dimmer"></div>
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.png"
               alt="Jiessie" />
          <p class="site-author-name" itemprop="name">Jiessie</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/dwj999" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/duanwenjie568588" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.percona.com/" title="Percona" target="_blank">Percona</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://mariadb.com/kb/zh-cn/mariadb/" title="MariaDB" target="_blank">MariaDB</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://mysqlserverteam.com/" title="serverteam" target="_blank">serverteam</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://mysqlhighavailability.com/" title="highavailability" target="_blank">highavailability</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://mysql.taobao.org/monthly/" title="淘宝月报" target="_blank">淘宝月报</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.innomysql.com/" title="姜承尧" target="_blank">姜承尧</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://imysql.com/" title="叶金荣" target="_blank">叶金荣</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://hedengcheng.com/" title="何登成" target="_blank">何登成</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.penglixun.com/" title="彭立勋" target="_blank">彭立勋</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://dbarobin.com/" title="温国兵" target="_blank">温国兵</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://dimitrik.free.fr/" title="dimitrik" target="_blank">dimitrik</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.itpub.net/22664653" title="杨奇龙" target="_blank">杨奇龙</a>
                </li>
              
            </ul>
          </div>
        

        

      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">2.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装配置详解"><span class="nav-number">3.</span> <span class="nav-text">安装配置详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动"><span class="nav-number">3.2.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内置对象介绍"><span class="nav-number">4.</span> <span class="nav-text">内置对象介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#登录"><span class="nav-number">4.1.</span> <span class="nav-text">登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内置库"><span class="nav-number">4.2.</span> <span class="nav-text">内置库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#main库"><span class="nav-number">4.2.1.</span> <span class="nav-text">main库</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#runtime-表"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">runtime_表</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#global-variables表"><span class="nav-number">4.2.1.1.1.</span> <span class="nav-text">global_variables表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#mysql-servers表"><span class="nav-number">4.2.1.1.2.</span> <span class="nav-text">mysql_servers表</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-users表"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">mysql_users表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-replication-hostgroups表"><span class="nav-number">4.2.1.3.</span> <span class="nav-text">mysql_replication_hostgroups表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-query-rules查询规则表"><span class="nav-number">4.2.1.4.</span> <span class="nav-text">mysql_query_rules查询规则表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#scheduler调度表"><span class="nav-number">4.2.1.5.</span> <span class="nav-text">scheduler调度表</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#disk库"><span class="nav-number">4.2.2.</span> <span class="nav-text">disk库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#stats库"><span class="nav-number">4.2.3.</span> <span class="nav-text">stats库</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#stats-mysql-commands-counters表"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">stats_mysql_commands_counters表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stats-mysql-global表"><span class="nav-number">4.2.3.2.</span> <span class="nav-text">stats_mysql_global表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stats-mysql-processlist表"><span class="nav-number">4.2.3.3.</span> <span class="nav-text">stats_mysql_processlist表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stats-mysql-query-digest表"><span class="nav-number">4.2.3.4.</span> <span class="nav-text">stats_mysql_query_digest表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stats-mysql-query-rules表"><span class="nav-number">4.2.3.5.</span> <span class="nav-text">stats_mysql_query_rules表</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#monitor库"><span class="nav-number">4.2.4.</span> <span class="nav-text">monitor库</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-server-connect-mysql-server-connect-log表"><span class="nav-number">4.2.4.1.</span> <span class="nav-text">mysql_server_connect/mysql_server_connect_log表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-server-ping-mysql-server-ping-log表"><span class="nav-number">4.2.4.2.</span> <span class="nav-text">mysql_server_ping/mysql_server_ping_log表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-server-replication-lag-log表"><span class="nav-number">4.2.4.3.</span> <span class="nav-text">mysql_server_replication_lag_log表</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内置参数"><span class="nav-number">4.2.5.</span> <span class="nav-text">内置参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ProxySQL多层配置设计"><span class="nav-number">4.3.</span> <span class="nav-text">ProxySQL多层配置设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ProxySQL设计模型介绍"><span class="nav-number">4.3.1.</span> <span class="nav-text">ProxySQL设计模型介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ProxySQL多层配置修改示例"><span class="nav-number">4.3.1.1.</span> <span class="nav-text">ProxySQL多层配置修改示例</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProxySQL读写分离示例"><span class="nav-number">5.</span> <span class="nav-text">ProxySQL读写分离示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备-1"><span class="nav-number">5.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装配置"><span class="nav-number">5.2.</span> <span class="nav-text">安装配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例目标"><span class="nav-number">5.3.</span> <span class="nav-text">示例目标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加后端DB服务"><span class="nav-number">5.4.</span> <span class="nav-text">添加后端DB服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加访问用户"><span class="nav-number">5.5.</span> <span class="nav-text">添加访问用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加复制关系"><span class="nav-number">5.6.</span> <span class="nav-text">添加复制关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改全局变量"><span class="nav-number">5.7.</span> <span class="nav-text">修改全局变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由规则"><span class="nav-number">5.8.</span> <span class="nav-text">路由规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常用查询"><span class="nav-number">5.9.</span> <span class="nav-text">常用查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProxySQL监控"><span class="nav-number">6.</span> <span class="nav-text">ProxySQL监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PMM-Client安装"><span class="nav-number">6.1.</span> <span class="nav-text">PMM Client安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PMM-Client配置"><span class="nav-number">6.2.</span> <span class="nav-text">PMM Client配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PMM-Server监控展示"><span class="nav-number">6.3.</span> <span class="nav-text">PMM Server监控展示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>
</div>

<!--
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
-->


<!--
<div class="powered-by">
  由 <a class="theme-link">Hexo</a> 强力驱动
</div>
-->

<!--
<div class="powered-by"><i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">  本站访客数:<span id="busuanzi_value_site_uv"></span></span></div>
-->

<!--
<div class="theme-info">
  主题 -
<a class="theme-link" >
    NexT.Pisces
  </a>
</div>
-->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?61e780d405f976f630dfbaf52d2beaa9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

<script>
(function(){
   var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?5dcca2e10541bbc392d713d47899a7ef":"https://jspassport.ssl.qhimg.com/11.0.1.js?5dcca2e10541bbc392d713d47899a7ef";
   document.write('<script src="' + src + '" id="sozz"><\/script>');
})();
</script>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  <!-- custom analytics part create by xiamo -->
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("ru8elRBhvqu5dW9MdsMn8nia-gzGzoHsz", "k1eCHPlnP0MAYwFV5aUjRojp");</script>
<script>
function showTime(Counter) {
	var query = new AV.Query(Counter);
	$(".leancloud_visitors").each(function() {
		var url = $(this).attr("id").trim();
		query.equalTo("url", url);
		query.find({
			success: function(results) {
				if (results.length == 0) {
					var content = '0 ' + $(document.getElementById(url)).text();
					$(document.getElementById(url)).text(content);
					return;
				}
				for (var i = 0; i < results.length; i++) {
					var object = results[i];
					var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
					$(document.getElementById(url)).text(content);
				}
			},
			error: function(object, error) {
				console.log("Error: " + error.code + " " + error.message);
			}
		});

	});
}

function addCount(Counter) {
	var Counter = AV.Object.extend("Counter");
	url = $(".leancloud_visitors").attr('id').trim();
	title = $(".leancloud_visitors").attr('data-flag-title').trim();
	var query = new AV.Query(Counter);
	query.equalTo("url", url);
	query.find({
		success: function(results) {
			if (results.length > 0) {
				var counter = results[0];
				counter.fetchWhenSave(true);
				counter.increment("time");
				counter.save(null, {
					success: function(counter) {
						var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
						$(document.getElementById(url)).text(content);
					},
					error: function(counter, error) {
						console.log('Failed to save Visitor num, with error message: ' + error.message);
					}
				});
			} else {
				var newcounter = new Counter();
				newcounter.set("title", title);
				newcounter.set("url", url);
				newcounter.set("time", 1);
				newcounter.save(null, {
					success: function(newcounter) {
					    console.log("newcounter.get('time')="+newcounter.get('time'));
						var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
						$(document.getElementById(url)).text(content);
					},
					error: function(newcounter, error) {
						console.log('Failed to create');
					}
				});
			}
		},
		error: function(error) {
			console.log('Error:' + error.code + " " + error.message);
		}
	});
}
$(function() {
	var Counter = AV.Object.extend("Counter");
	if ($('.leancloud_visitors').length == 1) {
		addCount(Counter);
	} else if ($('.post-title-link').length > 1) {
		showTime(Counter);
	}
}); 
</script>

  

  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("ru8elRBhvqu5dW9MdsMn8nia-gzGzoHsz", "k1eCHPlnP0MAYwFV5aUjRojp");AV.useAVCloudUS();</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>

